<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯èªè½åŠ›æ‰‹ç¹ªç‰ˆ V3.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* --- è«è˜­è¿ªè‰²ç³»èˆ‡æ‰‹ç¹ªé¢¨æ ¼è¨­å®š --- */
        :root {
            --bg-color: #F0EBE5; /* æš–ç°ç±³è‰² */
            --card-bg: #FCFAF8;
            --primary: #8CA3A3; /* è«è˜­è¿ªç¶  */
            --primary-dark: #6D8282;
            --accent: #D4A5A5; /* è«è˜­è¿ªç²‰ */
            --text: #5A5A5A;
            --border-color: #5A5A5A;
        }

        body {
            font-family: 'Kaiti', 'DFKai-SB', 'Microsoft JhengHei', cursive; /* å˜—è©¦ä½¿ç”¨æ¥·é«”æˆ–æ‰‹å¯«æ„Ÿå­—é«” */
            background-color: var(--bg-color);
            background-image: radial-gradient(#d8d3cd 1px, transparent 1px);
            background-size: 20px 20px; /* é»é»ç´™è³ªæ„Ÿ */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--text);
        }

        /* æ‰‹ç¹ªé¢¨æ ¼å®¹å™¨ */
        .container {
            background: var(--card-bg);
            padding: 30px;
            width: 95%;
            max-width: 800px;
            margin-bottom: 20px;
            position: relative;
            /* æ‰‹ç¹ªä¸è¦å‰‡é‚Šæ¡† */
            border: 2px solid var(--border-color);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 5px 5px 0px rgba(90, 90, 90, 0.2);
            transition: transform 0.2s;
        }

        h1, h2, h3 { color: var(--text); letter-spacing: 1px; }

        /* æ‰‹ç¹ªé¢¨æ ¼æŒ‰éˆ• */
        .btn {
            border: 2px solid var(--border-color);
            padding: 10px 25px;
            font-family: inherit;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 8px;
            color: white;
            background: var(--primary);
            /* æ‰‹ç¹ªåœ“è§’ */
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 3px 3px 0px var(--border-color);
            transition: all 0.2s;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px var(--border-color); }
        .btn:hover { background: var(--primary-dark); }
        .btn-accent { background: var(--accent); }

        /* è¼¸å…¥æ¡†æ‰‹ç¹ªåŒ– */
        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-sizing: border-box;
            font-family: inherit;
            margin: 10px 0;
            outline: none;
        }
        textarea:focus, input:focus { border-color: var(--accent); }

        /* è©å¡æ¨£å¼ - æ›´åŠ æµæš¢ */
        .word-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            min-height: 120px;
            padding: 25px;
            border: 2px dashed #bbb;
            border-radius: 20px;
            background-color: rgba(255,255,255,0.4);
            margin: 20px 0;
        }

        .word-card {
            background: white;
            border: 2px solid var(--border-color);
            padding: 10px 20px;
            /* ä¸è¦å‰‡å¡ç‰‡å½¢ç‹€ */
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            cursor: grab;
            font-size: 20px;
            font-weight: bold;
            color: #444;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.1);
            user-select: none;
            touch-action: none; /* é—œéµï¼šé˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•ç•«é¢ */
        }
        
        /* SortableJS çš„æ‹–æ›³æ¨£å¼ */
        .sortable-ghost { opacity: 0.3; background: #ddd; border: 2px dashed #999; }
        .sortable-drag { cursor: grabbing; opacity: 1; transform: rotate(3deg) scale(1.05); }

        /* éš±è—å…ƒç´  */
        .hidden { display: none !important; }

        /* è­¦å‘Šæ–‡å­— */
        .warning { color: #d9534f; font-size: 14px; margin-top: 5px; font-weight: bold;}

        /* æˆç¸¾å–®è“‹ç« æ•ˆæœ */
        .stamp {
            position: absolute; right: 20px; bottom: 20px;
            font-size: 40px; padding: 10px;
            color: #d32f2f; border: 3px solid #d32f2f;
            border-radius: 10px; transform: rotate(-15deg);
            font-family: 'Arial', sans-serif;
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.8);
        }

    </style>
</head>
<body>

    <h1 id="main-title">â˜ï¸ è¯èªè½åŠ›ç·´ç¿’</h1>

    <div id="teacher-setup" class="container">
        <h2>âœï¸ è€å¸«å‡ºé¡Œ (è«è˜­è¿ªæ‰‹ç¹ªç‰ˆ)</h2>
        
        <label>1. ä½œæ¥­æ¨™é¡Œ</label>
        <input type="text" id="input-title" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸‰èª² é€±æœ«è¨ˆç•«">
        
        <label>2. è¼¸å…¥é¡Œç›® (ä¸€è¡Œä¸€å¥ï¼Œç”¨ / åˆ‡å‰²)</label>
        <textarea id="input-sentences" style="height: 150px;" placeholder="ç¯„ä¾‹ï¼š&#10;æˆ‘/è¦ºå¾—/ä¸­æ–‡/å¾ˆ/æœ‰è¶£/ã€‚&#10;ä»Šå¤©/å¤©æ°£/çœŸ/ä¸éŒ¯/ã€‚" oninput="checkLength()"></textarea>
        <div id="length-warning" class="warning hidden">âš ï¸ é¡Œç›®é‡æœ‰é»å¤šï¼Œç¶²å€å¯èƒ½æœƒéé•·ï¼Œå»ºè­°åˆªæ¸›å¹¾é¡Œæˆ–åˆ†å…©æ¬¡å‡ºã€‚</div>
        
        <label>3. é é¦–åœ–ç‰‡ç¶²å€ (é¸å¡«)</label>
        <input type="text" id="input-img" placeholder="https://...">

        <button class="btn" onclick="generateLink()">âœ¨ ç”¢ç”Ÿä½œæ¥­é€£çµ</button>

        <div id="result-box" class="hidden" style="margin-top:20px; padding:15px; border-top: 2px dashed #ccc;">
            <p>âœ… ç¶²å€å·²ç”Ÿæˆ (å·²å£“ç¸®å„ªåŒ–)ï¼š</p>
            <textarea id="generated-link" style="height:60px; font-size:12px;" readonly></textarea>
            <button class="btn btn-accent" onclick="copyLink()">ğŸ“‹ è¤‡è£½ç¶²å€</button>
            <button class="btn" onclick="testPlay()">ğŸ® ç«‹å³è©¦ç©</button>
        </div>
    </div>

    <div id="student-login" class="container hidden" style="text-align: center;">
        <img id="login-img" class="hidden" src="" style="max-width:100%; max-height:200px; border-radius:10px; margin-bottom:15px;">
        <h2 id="login-title">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
        <p>è«‹å¯«ä¸‹ä½ çš„åå­—ï¼š</p>
        <input type="text" id="student-name" placeholder="Name" style="text-align:center; font-size:22px; width: 80%;">
        <br><br>
        <button class="btn btn-accent" onclick="startQuiz()">ğŸš€ é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="game-area" class="container hidden">
        <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--primary-dark);">
            <span>ğŸ‘¤ <span id="display-name"></span></span>
            <span>ğŸ“ <span id="current-q">1</span> / <span id="total-q">10</span></span>
        </div>
        <hr style="border:0; border-top: 2px dashed #ccc; margin: 15px 0;">

        <img id="game-header-img" class="hidden" src="" style="max-height:150px; margin:0 auto; display:block; border-radius:10px;">

        <div style="margin: 20px 0; text-align: center;">
            <button class="btn" onclick="playAudio(1)">ğŸ”Š è½è½çœ‹</button>
            <button class="btn btn-accent" style="font-size:16px;" onclick="playAudio(0.7)">ğŸ¢ æ…¢ä¸€é»</button>
        </div>

        <p style="text-align:center; color:#777;">â˜Ÿ è«‹æ‹–æ›³å¡ç‰‡æ’é †åº</p>
        
        <div class="word-container" id="sortable-list"></div>

        <div id="feedback" style="font-size:20px; height:30px; font-weight:bold; margin:10px; text-align:center;"></div>
        
        <div style="text-align: center;">
            <button class="btn" style="background:#e0e0e0; color:#555;" onclick="checkAnswer()">âœ… æª¢æŸ¥</button>
            <button id="next-btn" class="btn btn-accent hidden" onclick="nextQuestion()">ğŸ‘‰ ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="result-area" class="container hidden" style="background: white;">
        <h2 style="color:var(--primary-dark);">ğŸ† æˆç¸¾å–®</h2>
        <hr style="border: 2px solid var(--primary); margin: 10px 0;">
        
        <h3 id="result-title-display" style="color:#555;"></h3>
        <p style="font-size:20px;">å§“åï¼š<strong id="result-name" style="font-size:28px; border-bottom:3px solid var(--accent); padding:0 10px;"></strong></p>
        
        <div style="background:var(--bg-color); padding:20px; border-radius:20px; margin:20px 0; display:inline-block; min-width: 200px;">
            <span style="font-size:16px; color:#666;">ç¸½åˆ† Score</span><br>
            <span id="final-score" style="font-size:64px; color:var(--primary-dark); font-weight:bold;">100</span>
        </div>

        <p style="color:#999; font-size:14px;">Date: <span id="finish-date"></span></p>
        
        <div class="stamp">Excellent!</div>
        <br>
        <p style="color:var(--accent); font-weight:bold;">âœ¨ è«‹æˆªåœ–å‚³çµ¦è€å¸« âœ¨</p>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let questions = [];
        let currentIdx = 0;
        let score = 0;
        let studentName = "";
        let pageSettings = { title: "è½åŠ›ç·´ç¿’", img: "" };
        let sortableInstance = null; // Sortable å¯¦ä¾‹

        // --- 1. å£“ç¸®èˆ‡è§£å£“ç¸®é‚è¼¯ (è§£æ±ºç¶²å€éé•·) ---
        // ä½¿ç”¨ LZString åº«é€²è¡Œå£“ç¸®

        function generateLink() {
            const title = document.getElementById('input-title').value.trim() || "è½åŠ›ç·´ç¿’";
            const img = document.getElementById('input-img').value.trim();
            const rawText = document.getElementById('input-sentences').value.trim();

            if (!rawText) return alert("è«‹è¼¸å…¥é¡Œç›®ï¼");

            const qList = [];
            const lines = rawText.split('\n');
            for (let line of lines) {
                line = line.trim();
                if (line) {
                    const chunks = line.split('/').map(w => w.trim()).filter(w => w);
                    if (chunks.length > 0) qList.push({ full: chunks.join(""), words: chunks });
                }
            }

            // æ‰“åŒ…
            const pack = { s: { title: title, img: img }, q: qList };
            const jsonString = JSON.stringify(pack);

            // æ ¸å¿ƒæ”¹è®Šï¼šä½¿ç”¨ LZString å£“ç¸®
            const compressed = LZString.compressToEncodedURIComponent(jsonString);
            
            // æª¢æŸ¥é•·åº¦
            const finalUrl = `${window.location.href.split('?')[0]}?data=${compressed}`;
            
            if (finalUrl.length > 8000) {
                alert("è­¦å‘Šï¼šé¡Œç›®çœŸçš„å¤ªå¤šäº†ï¼Œç¶²å€è¶…éç€è¦½å™¨æ¥µé™ï¼è«‹æ¸›å°‘å¹¾é¡Œã€‚");
                return;
            }

            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('generated-link').value = finalUrl;
        }

        // --- åˆå§‹åŒ–è®€å– ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('data'); // æ”¹ç”¨ 'data' åƒæ•¸

            if (compressedData) {
                // æœ‰è³‡æ–™ -> å­¸ç”Ÿæ¨¡å¼
                try {
                    // è§£å£“ç¸®
                    const jsonString = LZString.decompressFromEncodedURIComponent(compressedData);
                    const decoded = JSON.parse(jsonString);
                    
                    questions = decoded.q;
                    pageSettings = decoded.s || pageSettings;
                    enterLoginMode();
                } catch (e) {
                    console.error(e);
                    alert("é€£çµè®€å–å¤±æ•— (å¯èƒ½ç¶²å€ä¸å®Œæ•´)");
                }
            } else {
                // èˆŠç‰ˆç›¸å®¹ (å¦‚æœè€å¸«ç”¨äº†èˆŠé€£çµ ?q=...)
                const oldData = urlParams.get('q');
                if(oldData) {
                     try {
                        const decoded = JSON.parse(decodeURIComponent(atob(oldData)));
                        questions = decoded.q;
                        pageSettings = decoded.s || pageSettings;
                        enterLoginMode();
                    } catch(e) { alert("é€£çµç„¡æ•ˆ"); }
                } else {
                    document.getElementById('teacher-setup').classList.remove('hidden');
                }
            }
        };

        // --- è€å¸«ç«¯è¼”åŠ©åŠŸèƒ½ ---
        function checkLength() {
            const text = document.getElementById('input-sentences').value;
            const lines = text.split('\n').filter(l => l.trim() !== '').length;
            const warning = document.getElementById('length-warning');
            
            // ä¼°ç®—ï¼šé€šå¸¸å£“ç¸®å¾Œ 30-40 é¡Œæ˜¯æ¥µé™ï¼Œé€™è£¡ä¿å®ˆæŠ“ 25 é¡Œæé†’
            if (lines > 25) {
                warning.classList.remove('hidden');
                warning.innerText = `âš ï¸ ç›®å‰ç´„ ${lines} é¡Œï¼Œå»ºè­°ä¸è¦è¶…é 30 é¡Œä»¥å…ç¶²å€å¤±æ•ˆã€‚`;
            } else {
                warning.classList.add('hidden');
            }
        }

        function copyLink() {
            const copyText = document.getElementById("generated-link");
            copyText.select();
            document.execCommand("copy");
            alert("ç¶²å€å·²è¤‡è£½ï¼");
        }
        
        function testPlay() {
            window.location.href = document.getElementById("generated-link").value;
        }

        // --- å­¸ç”Ÿæ¨¡å¼é‚è¼¯ ---
        function enterLoginMode() {
            document.getElementById('teacher-setup').classList.add('hidden');
            document.getElementById('student-login').classList.remove('hidden');
            
            document.getElementById('main-title').innerText = pageSettings.title;
            document.getElementById('login-title').innerText = pageSettings.title;
            
            if(pageSettings.img) {
                const imgTag = document.getElementById('login-img');
                imgTag.src = pageSettings.img;
                imgTag.classList.remove('hidden');
            }
        }

        function startQuiz() {
            const nameInput = document.getElementById('student-name').value.trim();
            if (!nameInput) return alert("è«‹è¼¸å…¥åå­—å–”ï¼");
            
            studentName = nameInput;
            document.getElementById('display-name').innerText = studentName;
            
            document.getElementById('student-login').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            
            if(pageSettings.img) {
                const gameImg = document.getElementById('game-header-img');
                gameImg.src = pageSettings.img;
                gameImg.classList.remove('hidden');
            }

            currentIdx = 0;
            score = 0;
            loadQuestion();
        }

        function loadQuestion() {
            document.getElementById('current-q').innerText = currentIdx + 1;
            document.getElementById('total-q').innerText = questions.length;
            const list = document.getElementById('sortable-list');
            const feedback = document.getElementById('feedback');
            const nextBtn = document.getElementById('next-btn');
            
            feedback.innerText = "";
            nextBtn.classList.add('hidden');
            list.innerHTML = "";

            // éš¨æ©Ÿæ’åˆ—
            let words = [...questions[currentIdx].words];
            words.sort(() => Math.random() - 0.5);

            words.forEach(word => {
                const item = document.createElement('div');
                item.classList.add('word-card');
                item.innerText = word;
                list.appendChild(item);
            });

            // --- 2. å•Ÿå‹• SortableJS (è§£æ±ºæ‹–æ›³ä¸é †) ---
            if (sortableInstance) sortableInstance.destroy(); // æ¸…é™¤èˆŠçš„
            
            sortableInstance = new Sortable(list, {
                animation: 150, // å‹•ç•«é€Ÿåº¦ (ms)
                ghostClass: 'sortable-ghost', // æ‹–æ›³æ™‚åŸä½ç½®çš„æ¨£å¼
                dragClass: 'sortable-drag', // æ‹–æ›³ä¸­çš„æ¨£å¼
                delay: 0, // æ‰‹æ©Ÿé»æ“Šç«‹å³åæ‡‰
                touchStartThreshold: 3 // é˜²æ­¢èª¤è§¸
            });
        }

        function playAudio(rate) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(questions[currentIdx].full);
                u.lang = 'zh-TW';
                u.rate = rate;
                window.speechSynthesis.speak(u);
            }
        }

        let hasTriedCurrent = false;

        function checkAnswer() {
             const nextBtn = document.getElementById('next-btn');
             if(!nextBtn.classList.contains('hidden')) return; 

             // æŠ“å– Sortable æ’åˆ—å¾Œçš„é †åº
             const currentSentence = [...document.querySelectorAll('.word-card')].map(c => c.innerText).join("");
             const correct = questions[currentIdx].full;
             const feedback = document.getElementById('feedback');

             if (currentSentence === correct) {
                 feedback.innerText = "ğŸ‰ ç­”å°äº†ï¼ Correct!";
                 feedback.style.color = "var(--primary-dark)";
                 if (!hasTriedCurrent) score++;
                 
                 nextBtn.classList.remove('hidden');
                 
                 // é–å®šæ‹–æ›³
                 if (sortableInstance) sortableInstance.option("disabled", true);
                 document.querySelectorAll('.word-card').forEach(c => c.style.background = "#e0f2f1");
                 
             } else {
                 feedback.innerText = "âŒ å†è©¦è©¦çœ‹ Try again";
                 feedback.style.color = "#d32f2f";
                 hasTriedCurrent = true;
             }
        }

        function nextQuestion() {
            currentIdx++;
            hasTriedCurrent = false;
            if (currentIdx < questions.length) {
                loadQuestion();
            } else {
                showResult();
            }
        }

        function showResult() {
            document.getElementById('game-area').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            
            document.getElementById('result-title-display').innerText = pageSettings.title;
            document.getElementById('result-name').innerText = studentName;
            
            const finalScore = Math.round((score / questions.length) * 100);
            document.getElementById('final-score').innerText = finalScore;
            
            const d = new Date();
            document.getElementById('finish-date').innerText = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        }

    </script>
</body>
</html>