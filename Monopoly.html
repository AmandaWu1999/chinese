<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè©å¤§å¯Œç¿ - å€’æ•¸è¨ˆæ™‚ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* å­—é«”èˆ‡å‹•ç•«è¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=ZCOOL+KuaiLe&display=swap');
        @keyframes pop { 0% { transform: scale(0.9); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes pulse-red { 0% { color: #ef4444; } 50% { color: #991b1b; } 100% { color: #ef4444; } }
        
        body { font-family: 'Noto Sans TC', sans-serif; transition: background 0.5s ease; }
        
        /* ç½²åæµ®æ°´å° */
        .credit-footer {
            position: fixed; bottom: 8px; right: 12px; font-size: 0.75rem; 
            color: rgba(0,0,0,0.5); pointer-events: none; z-index: 9999;
            background: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 4px;
        }
        .theme-geometric .credit-footer { color: rgba(255,255,255,0.5); background: rgba(0,0,0,0.7); }

        /* éŠæˆ²ç›¤ä½ˆå±€ */
        .board-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 4px;
            width: 100%; max-width: 800px; aspect-ratio: 1/1; margin: 0 auto;
        }
        .cell {
            position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 6px; font-size: 0.75rem; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 2px; text-align: center;
        }
        .center-area {
            grid-column: 2 / 8; grid-row: 2 / 8; display: flex; flex-direction: column; justify-content: center;
            align-items: center; background: rgba(255,255,255,0.85); border-radius: 12px; padding: 10px; z-index: 10;
        }
        /* ç©å®¶æ£‹å­ (é ­åƒ) */
        .token {
            width: 28px; height: 28px; border-radius: 50%; position: absolute; z-index: 20;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center; font-size: 16px; background: white;
            transition: all 0.5s ease-in-out;
        }
        .token.p1 { top: -5px; left: -5px; border-color: #ef4444; }
        .token.p2 { bottom: -5px; right: -5px; border-color: #3b82f6; }
        .owner-mark {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 3px solid transparent; border-radius: 6px; pointer-events: none;
        }

        /* --- é¢¨æ ¼ä¸»é¡Œè®Šæ•¸ --- */
        .theme-morandi { background-color: #e8e6e1; color: #5e5e5e; } .theme-morandi .cell { background: #d6cfc7; }
        .theme-chalkboard { background-color: #2b3a42; color: #eee; font-family: 'ZCOOL KuaiLe'; } .theme-chalkboard .cell { background: #3e505b; border: 1px dashed #777; color:white;}
        .theme-flat { background-color: #f3f4f6; } .theme-flat .cell { background: white; border: 2px solid #e5e7eb; }
        .theme-watercolor { background: linear-gradient(135deg, #fdfbfb, #ebedee); } .theme-watercolor .cell { background: rgba(255,255,255,0.7); border-radius: 12px 4px; }
        .theme-chibi { background-color: #fff1f2; font-family: 'ZCOOL KuaiLe'; } .theme-chibi .cell { background: #ffe4e6; border: 3px solid #fda4af; border-radius: 15px; }
        .theme-geometric { background-color: #111827; color: #d1d5db; } .theme-geometric .cell { background: #1f2937; border: 1px solid #374151; }

        /* Modal Overlay */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 420px;
            text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); animation: pop 0.3s; color: #333;
        }
        
        /* è¨ˆæ™‚å™¨å‹•ç•« */
        .timer-urgent { animation: pulse-red 1s infinite; font-weight: 800; color: #ef4444; }
    </style>
</head>
<body class="theme-flat h-screen flex flex-col items-center overflow-hidden bg-gray-100">

    <div class="credit-footer">æä¾›è€…: å°å¸«å¤§å³ç©ç´”è€å¸«</div>

    <div id="setup-screen" class="w-full h-full absolute top-0 left-0 bg-white z-50 flex flex-col items-center justify-start p-4 overflow-y-auto font-sans text-gray-800">
        <div class="max-w-2xl w-full space-y-5 my-4">
            <h1 class="text-3xl font-bold text-center text-blue-600">â³ ç”Ÿè©å¤§å¯Œç¿ (è¨ˆæ™‚ç‰ˆ)</h1>
            
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                <h2 class="font-bold text-lg">1. ç©å®¶è¨­å®š</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-lg border">
                        <label class="block text-sm font-bold text-red-600 mb-1">ç©å®¶ 1</label>
                        <input type="text" id="p1-name" value="è€å¸«" class="w-full border p-1 rounded mb-2 text-sm">
                        <select id="p1-avatar" class="w-full border p-1 rounded text-xl">
                            <option value="ğŸ‘©â€ğŸ«" selected>ğŸ‘©â€ğŸ« è€å¸«A</option>
                            <option value="ğŸ¦">ğŸ¦ ç…å­</option>
                            <option value="ğŸ¤–">ğŸ¤– æ©Ÿå™¨äºº</option>
                        </select>
                    </div>
                    <div class="bg-white p-3 rounded-lg border">
                        <label class="block text-sm font-bold text-blue-600 mb-1">ç©å®¶ 2</label>
                        <input type="text" id="p2-name" value="å­¸ç”Ÿ" class="w-full border p-1 rounded mb-2 text-sm">
                        <select id="p2-avatar" class="w-full border p-1 rounded text-xl">
                            <option value="ğŸ‘¨â€ğŸ“" selected>ğŸ‘¨â€ğŸ“ å­¸ç”ŸB</option>
                            <option value="ğŸ¦Š">ğŸ¦Š ç‹ç‹¸</option>
                            <option value="ğŸš€">ğŸš€ ç«ç®­</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                <label class="block font-bold text-lg mb-2 text-yellow-800">â° 2. éŠæˆ²æ™‚é–“ (åˆ†é˜)</label>
                <div class="flex items-center gap-4">
                    <input type="number" id="game-duration" value="10" min="1" max="60" class="w-24 p-2 border border-yellow-400 rounded-lg text-xl text-center font-bold">
                    <span class="text-sm text-gray-600">åˆ†é˜å¾Œè‡ªå‹•çµæŸï¼Œè³‡ç”¢å¤šè€…ç²å‹ã€‚</span>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-3">
                <h2 class="font-bold text-lg">3. é¡Œç›®èˆ‡é¢¨æ ¼</h2>
                <select id="theme-select" class="w-full p-2 border border-gray-300 rounded mb-2">
                    <option value="theme-flat">æ‰å¹³æ’ç•«é¢¨ (Flat)</option>
                    <option value="theme-morandi">è«è˜­è¿ªç²‰å½© (Morandi)</option>
                    <option value="theme-watercolor">æ°´å½©æ¸²æŸ“é¢¨ (Watercolor)</option>
                    <option value="theme-chalkboard">æ•™å®¤é»‘æ¿é¢¨ (Chalkboard)</option>
                    <option value="theme-chibi">Q ç‰ˆå¯æ„›é¢¨ (Chibi)</option>
                </select>
                <textarea id="vocab-input" rows="4" class="w-full p-2 border border-gray-300 rounded font-mono text-sm" placeholder="è˜‹æœ,pÃ­ng guÇ’..."></textarea>
            </div>

            <button onclick="startGame()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 rounded-xl text-xl shadow-lg transition">
                ğŸš€ é–‹å§‹éŠæˆ²
            </button>
        </div>
    </div>

    <div id="game-container" class="hidden w-full h-full p-2 flex flex-col items-center justify-center relative">
        
        <div class="w-full max-w-4xl flex justify-between items-center mb-2 px-2 gap-2">
            <div class="flex items-center gap-2 bg-white/80 p-2 rounded-lg shadow border-l-4 border-red-500 flex-1">
                <div class="text-2xl">ğŸ‘©â€ğŸ«</div>
                <div>
                    <div class="text-xs opacity-70" id="p1-name-display">è€å¸«</div>
                    <div class="font-bold text-red-700">$<span id="p1-money">1000</span></div>
                </div>
            </div>
            
            <div class="flex flex-col items-center justify-center flex-1">
                <div id="timer-box" class="bg-gray-800 text-white px-4 py-1 rounded-lg font-mono text-xl font-bold shadow-md mb-1 flex items-center gap-2">
                    <span>â±ï¸</span>
                    <span id="time-display">10:00</span>
                </div>
                <div id="turn-indicator" class="text-xs px-3 py-1 bg-white/80 rounded-full shadow-sm whitespace-nowrap">
                    ç­‰å¾…é–‹å§‹...
                </div>
            </div>

            <div class="flex items-center gap-2 bg-white/80 p-2 rounded-lg shadow border-l-4 border-blue-500 flex-1 justify-end">
                <div class="text-right">
                    <div class="text-xs opacity-70" id="p2-name-display">å­¸ç”Ÿ</div>
                    <div class="font-bold text-blue-700">$<span id="p2-money">1000</span></div>
                </div>
                <div class="text-2xl">ğŸ‘¨â€ğŸ“</div>
            </div>
        </div>

        <div class="board-grid" id="board">
            <div class="center-area shadow-inner">
                <div class="text-6xl mb-2" id="dice-display">ğŸ²</div>
                <button id="roll-btn" onclick="rollDice()" class="px-6 py-2 bg-gray-900 text-white rounded-full text-lg font-bold shadow hover:bg-gray-700 transition">
                    æ“²éª°å­
                </button>
                <div id="message-box" class="mt-3 text-center text-sm min-h-[20px] font-medium bg-white/50 px-2 rounded">
                    æº–å‚™é–‹å§‹!
                </div>
            </div>
        </div>

    </div>

    <div id="quiz-modal" class="modal"><div class="modal-content"><h3 class="text-gray-500 text-sm mb-2">æ‹¼éŸ³æ˜¯ï¼Ÿ</h3><h2 id="quiz-word" class="text-5xl font-bold mb-6 text-center">ç”Ÿè©</h2><div id="quiz-options" class="space-y-3"></div></div></div>
    <div id="buy-modal" class="modal"><div class="modal-content"><div class="text-4xl mb-2">ğŸ‰ ç­”å°äº†ï¼</div><p class="mb-4">çé‡‘ <span class="text-green-600 font-bold">+$100</span></p><div class="bg-yellow-50 p-3 rounded mb-4"><span class="text-sm">åƒ¹æ ¼:</span><span id="land-price" class="text-2xl font-bold text-yellow-700 ml-2">$200</span></div><p id="buy-prompt-text" class="mb-4 font-bold">è¦è²·å—ï¼Ÿ</p><div class="flex gap-3 justify-center"><button id="buy-confirm-btn" onclick="handleBuy(true)" class="bg-green-500 text-white py-2 px-6 rounded font-bold">è²·</button><button onclick="handleBuy(false)" class="bg-gray-300 py-2 px-6 rounded font-bold">PASS</button></div></div></div>
    
    <div id="game-over-modal" class="modal">
        <div class="modal-content relative overflow-hidden">
            <h1 class="text-4xl mb-2">ğŸ† éŠæˆ²çµæŸ</h1>
            <div class="text-6xl mb-4" id="winner-avatar">ğŸ‘‘</div>
            <p id="winner-text" class="text-2xl font-bold mb-2 text-blue-600">ç²å‹è€…</p>
            <p id="win-reason" class="text-gray-500 mb-6 font-bold text-red-500 text-lg">æ™‚é–“åˆ°ï¼</p>
            <button onclick="location.reload()" class="bg-blue-600 text-white py-3 px-10 rounded-full font-bold shadow-lg">å†ä¾†ä¸€å±€</button>
        </div>
    </div>

    <script>
        // --- éŸ³æ•ˆ ---
        const sounds = {
            dice: new Audio('https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3'),
            buy: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),
            pay: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3'),
            win: new Audio('https://assets.mixkit.co/active_storage/sfx/2020/2020-preview.mp3'),
            alarm: new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3') // æ™‚é–“å¿«åˆ°
        };
        Object.values(sounds).forEach(s => { s.volume = 0.5; });

        function playSound(name) { sounds[name].currentTime = 0; sounds[name].play().catch(()=>{}); }

        // --- è®Šæ•¸ ---
        const defaultVocab = `é–‹å§‹,kÄi shÇ\næº–å‚™,zhÇ”n bÃ¨i\nå› ç‚º,yÄ«n wÃ¨i\næ‰€ä»¥,suÇ’ yÇ\né›–ç„¶,suÄ« rÃ¡n\nä½†æ˜¯,dÃ n shÃ¬\nå¦‚æœ,rÃº guÇ’\nè¦ºå¾—,juÃ© de\nå–œæ­¡,xÇ huÄn\nèªè­˜,rÃ¨n shi\nä»‹ç´¹,jiÃ¨ shÃ o\nå¹«å¿™,bÄng mÃ¡ng\nå¿«æ¨‚,kuÃ i lÃ¨\nå®¹æ˜“,rÃ³ng yÃ¬\nç°¡å–®,jiÇn dÄn\nè¾›è‹¦,xÄ«n kÇ”\nå¥åº·,jiÃ n kÄng\né‹å‹•,yÃ¹n dÃ²ng\næ—…è¡Œ,lÇš xÃ­ng\nåƒè§€,cÄn guÄn\né¢¨æ™¯,fÄ“ng jÇng\næ—…é¤¨,lÇš guÇn\næ©Ÿç¥¨,jÄ« piÃ o\nè­·ç…§,hÃ¹ zhÃ o\næ–¹ä¾¿,fÄng biÃ n\néº»ç…©,mÃ¡ fan\nç·´ç¿’,liÃ n xÃ­\nè¤‡ç¿’,fÃ¹ xÃ­`;
        document.getElementById('vocab-input').value = defaultVocab;

        let vocabList = [], tiles = [], players = [], currentPlayerIndex = 0, isRolling = false;
        let gameTimer = null;
        let timeRemaining = 600; // ç§’

        // --- æ ¸å¿ƒèˆ‡è¨ˆæ™‚ ---
        function startGame() {
            // 1. è¨­å®šæ¨£å¼
            document.body.className = `${document.getElementById('theme-select').value} h-screen flex flex-col items-center overflow-hidden bg-gray-100`;

            // 2. ç©å®¶èˆ‡æ™‚é–“
            const durationMin = parseInt(document.getElementById('game-duration').value) || 10;
            timeRemaining = durationMin * 60;
            
            players = [
                { id: 0, name: document.getElementById('p1-name').value, avatar: document.getElementById('p1-avatar').value, money: 1000, pos: 0, color: "#ef4444" },
                { id: 1, name: document.getElementById('p2-name').value, avatar: document.getElementById('p2-avatar').value, money: 1000, pos: 0, color: "#3b82f6" }
            ];
            
            document.getElementById('p1-name-display').innerText = players[0].name;
            document.getElementById('p2-name-display').innerText = players[1].name;
            
            // 3. ç”Ÿè©è™•ç†
            const input = document.getElementById('vocab-input').value;
            vocabList = input.trim().split('\n').map(l => {
                const [w, p] = l.split(','); return { word: w?.trim(), pinyin: p?.trim() };
            }).filter(v => v.word && v.pinyin);
            while(vocabList.length < 28) vocabList.push({word: "ç„¡é¡Œ", pinyin: "wÃº tÃ­"});
            tiles = vocabList.slice(0,28).map((v, i) => ({
                id: i, word: v.word, pinyin: v.pinyin, price: Math.floor(Math.random()*10)*25+25, owner: null
            }));

            // 4. å•Ÿå‹•
            renderBoard();
            updateStats();
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            updateTurnIndicator();
            startTimer();
        }

        function startTimer() {
            updateTimerDisplay();
            gameTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(gameTimer);
                    endGame("timeup");
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
            const s = (timeRemaining % 60).toString().padStart(2, '0');
            const el = document.getElementById('time-display');
            el.innerText = `${m}:${s}`;
            
            // æœ€å¾Œ60ç§’è®Šç´…æé†’
            if (timeRemaining <= 60) {
                document.getElementById('timer-box').classList.add('timer-urgent', 'bg-red-100', 'text-red-600');
                document.getElementById('timer-box').classList.remove('bg-gray-800', 'text-white');
            }
        }

        // --- æ£‹ç›¤èˆ‡é‚è¼¯ ---
        function renderBoard() {
            const board = document.getElementById('board');
            const center = document.querySelector('.center-area');
            board.innerHTML = ''; board.appendChild(center);
            
            // 8x8 Grid Mapping
            const positions = [];
            for(let i=1; i<=8; i++) positions.push({r:1, c:i});
            for(let i=2; i<=7; i++) positions.push({r:i, c:8});
            for(let i=8; i>=1; i--) positions.push({r:8, c:i});
            for(let i=7; i>=2; i--) positions.push({r:i, c:1});

            tiles.forEach((tile, index) => {
                const el = document.createElement('div');
                el.className = 'cell bg-white/90';
                el.style.gridRow = positions[index].r; el.style.gridColumn = positions[index].c; el.id = `cell-${index}`;
                el.innerHTML = `<div class="text-[10px] text-gray-400">LAND</div><div class="font-bold text-gray-700">$${tile.price}</div><div class="owner-mark" id="owner-${index}"></div>`;
                board.appendChild(el);
            });
            updatePlayerTokens();
        }

        function updatePlayerTokens() {
            document.querySelectorAll('.token').forEach(e => e.remove());
            players.forEach((p, i) => {
                const cell = document.getElementById(`cell-${p.pos}`);
                const t = document.createElement('div');
                t.className = `token p${i+1}`; t.innerText = p.avatar;
                cell.appendChild(t);
            });
        }

        function updateStats() {
            document.getElementById('p1-money').innerText = players[0].money;
            document.getElementById('p2-money').innerText = players[1].money;
            if(players.some(p => p.money < 0)) endGame("bankruptcy");
        }

        function updateTurnIndicator() {
            const p = players[currentPlayerIndex];
            const div = document.getElementById('turn-indicator');
            div.innerHTML = `è¼ªåˆ°: <span class="font-bold">${p.avatar} ${p.name}</span>`;
            document.getElementById('roll-btn').disabled = false;
            document.getElementById('roll-btn').classList.remove('opacity-50');
            document.getElementById('message-box').innerText = `${p.name} è«‹æ“²éª°å­...`;
        }

        function rollDice() {
            if(isRolling) return;
            isRolling = true; playSound('dice');
            const display = document.getElementById('dice-display');
            document.getElementById('roll-btn').disabled = true;
            document.getElementById('roll-btn').classList.add('opacity-50');
            
            let steps = 0, interval = setInterval(() => {
                display.innerText = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][Math.floor(Math.random()*6)];
                if(++steps > 8) {
                    clearInterval(interval);
                    const move = Math.floor(Math.random()*6)+1;
                    display.innerText = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][move-1];
                    movePlayer(move);
                }
            }, 80);
        }

        function movePlayer(steps) {
            const p = players[currentPlayerIndex];
            let count = 0;
            const interval = setInterval(() => {
                p.pos = (p.pos + 1) % 28;
                updatePlayerTokens();
                if(++count >= steps) {
                    clearInterval(interval);
                    isRolling = false;
                    handleLandEvent(p.pos);
                }
            }, 200);
        }

        function handleLandEvent(pos) {
            const tile = tiles[pos];
            const p = players[currentPlayerIndex];
            const msg = document.getElementById('message-box');
            
            if (tile.owner === null) {
                msg.innerText = "å•ç­”ç’°ç¯€ï¼"; setTimeout(() => showQuiz(tile), 600);
            } else if (tile.owner === p.id) {
                msg.innerText = "è‡ªå·±é ˜åœ°ï¼Œä¼‘æ¯ã€‚"; setTimeout(nextTurn, 1000);
            } else {
                msg.innerHTML = `ä»˜éè·¯è²» <span class="text-red-600">$50</span>`;
                playSound('pay');
                p.money -= 50; players[tile.owner].money += 50;
                updateStats();
                document.getElementById(`cell-${pos}`).style.backgroundColor = '#fee2e2'; 
                setTimeout(() => { document.getElementById(`cell-${pos}`).style.backgroundColor = ''; nextTurn(); }, 1500);
            }
        }

        function showQuiz(tile) {
            currentQuizTile = tile;
            const modal = document.getElementById('quiz-modal');
            document.getElementById('quiz-word').innerText = tile.word;
            const opts = document.getElementById('quiz-options');
            opts.innerHTML = '';
            
            const ans = tile.pinyin;
            let others = vocabList.filter(v=>v.pinyin!==ans).sort(()=>0.5-Math.random()).slice(0,2);
            [ans, ...others].sort(()=>0.5-Math.random()).forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full py-3 px-4 bg-gray-50 border border-gray-200 rounded text-lg font-medium hover:bg-blue-100 text-left";
                btn.innerText = opt.pinyin || opt; // fix obj issue
                btn.onclick = () => handleAnswer(opt === ans || opt.pinyin === ans);
                opts.appendChild(btn);
            });
            modal.classList.add('active');
        }

        function handleAnswer(correct) {
            document.getElementById('quiz-modal').classList.remove('active');
            if(correct) {
                players[currentPlayerIndex].money += 100; updateStats(); showBuyModal();
            } else {
                document.getElementById('message-box').innerText = "ç­”éŒ¯äº†..."; setTimeout(nextTurn, 1000);
            }
        }

        function showBuyModal() {
            const p = players[currentPlayerIndex], tile = currentQuizTile;
            const modal = document.getElementById('buy-modal');
            document.getElementById('land-price').innerText = `$${tile.price}`;
            document.getElementById('buy-prompt-text').innerText = `${p.name} è¦è²·å—ï¼Ÿ`;
            const btn = document.getElementById('buy-confirm-btn');
            
            if(p.money < tile.price) {
                btn.disabled = true; btn.classList.add('opacity-50', 'bg-gray-400'); btn.innerText = "éŒ¢ä¸å¤ ";
            } else {
                btn.disabled = false; btn.classList.remove('opacity-50', 'bg-gray-400'); btn.classList.add('bg-green-500'); btn.innerText = "è²·";
            }
            modal.classList.add('active');
        }

        function handleBuy(buy) {
            document.getElementById('buy-modal').classList.remove('active');
            const p = players[currentPlayerIndex], tile = currentQuizTile;
            if(buy && p.money >= tile.price) {
                playSound('buy'); p.money -= tile.price; tile.owner = p.id;
                const mk = document.getElementById(`owner-${tile.id}`);
                mk.style.borderColor = p.color; mk.style.backgroundColor = p.color+'40';
                updateStats();
                document.getElementById('message-box').innerText = "è³¼è²·æˆåŠŸï¼";
            } else {
                document.getElementById('message-box').innerText = "æ”¾æ£„è³¼è²·ã€‚";
            }
            setTimeout(nextTurn, 1000);
        }

        function nextTurn() { currentPlayerIndex = (currentPlayerIndex+1)%2; updateTurnIndicator(); }

        function endGame(type) {
            if(gameTimer) clearInterval(gameTimer);
            playSound('win');
            
            // ç…™ç«
            const end = Date.now() + 3000;
            (function frame() {
                confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());

            let p1 = players[0], p2 = players[1], winner, reason;
            
            if (type === "timeup") {
                reason = "æ™‚é–“åˆ°ï¼è³‡ç”¢çµç®—";
                // æ¯”è¼ƒé‚è¼¯ï¼šç¾é‡‘å¤šè€…è´
                if (p1.money > p2.money) winner = p1;
                else if (p2.money > p1.money) winner = p2;
                else { winner = {name: "å¹³æ‰‹", avatar: "ğŸ¤"}; }
            } else {
                // ç ´ç”¢é‚è¼¯
                if (p1.money < 0) { winner = p2; reason = `${p1.name} ç ´ç”¢`; }
                else { winner = p1; reason = `${p2.name} ç ´ç”¢`; }
            }

            document.getElementById('winner-avatar').innerText = winner.avatar;
            document.getElementById('winner-text').innerText = winner.name === "å¹³æ‰‹" ? "å¹³æ‰‹ï¼" : `${winner.name} ç²å‹ï¼`;
            document.getElementById('win-reason').innerText = `(${reason})`;
            document.getElementById('game-over-modal').classList.add('active');
        }
    </script>
</body>
</html>
