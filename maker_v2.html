<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯èªè½åŠ›ç·´ç¿’ v2.0</title>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body { font-family: 'Microsoft JhengHei', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: #333; transition: background 0.3s; }
        
        /* å®¹å™¨æ¨£å¼ */
        .container { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); width: 95%; max-width: 800px; text-align: center; margin-bottom: 20px; position: relative; backdrop-filter: blur(5px); }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { border: none; padding: 12px 25px; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; margin: 8px; transition: transform 0.2s, box-shadow 0.2s; color: white; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn:hover { filter: brightness(1.1); }
        
        /* è¼¸å…¥æ¡†èˆ‡æ–‡å­—å€ */
        input[type="text"], textarea, select { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; font-family: inherit; margin: 5px 0; }
        textarea { height: 120px; resize: vertical; }

        /* è©å¡æ¨£å¼ */
        .word-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 20px 0; min-height: 100px; padding: 20px; border: 3px dashed #ccc; border-radius: 15px; background-color: rgba(255,255,255,0.5); }
        .word-card { background: white; border: 2px solid #888; padding: 10px 20px; border-radius: 12px; cursor: grab; user-select: none; box-shadow: 0 4px 0 #bbb; font-size: 20px; font-weight: bold; color: #444; touch-action: none; }
        .word-card:active { cursor: grabbing; transform: scale(0.95); }
        
        /* æˆç¸¾å–® (Certificate) */
        .certificate-box { border: 10px double #FFD700; padding: 40px; background: white; border-radius: 20px; position: relative; overflow: hidden; }
        .stamp { position: absolute; right: 20px; bottom: 20px; font-size: 80px; opacity: 0.2; transform: rotate(-20deg); color: red; font-weight: bold; border: 5px solid red; border-radius: 50%; width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; }

        /* ä¸»é¡Œé…è‰² Classes */
        .theme-forest { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); }
        .theme-forest .btn-main { background-color: #2e7d32; }
        .theme-forest h1 { color: #1b5e20; }
        
        .theme-ocean { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .theme-ocean .btn-main { background-color: #0277bd; }
        .theme-ocean h1 { color: #01579b; }

        .theme-candy { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); }
        .theme-candy .btn-main { background-color: #ec407a; }
        .theme-candy h1 { color: #880e4f; }

        /* éš±è—å…ƒç´  */
        .hidden { display: none !important; }
        
        /* åœ–ç‰‡é è¦½ */
        #header-img { max-width: 100%; max-height: 200px; border-radius: 10px; margin-bottom: 10px; object-fit: contain; }

    </style>
</head>
<body class="theme-forest"> <h1 id="main-title">ğŸŒ² è¯èªè½åŠ›ç·´ç¿’</h1>

    <div id="teacher-setup" class="container">
        <h2>ğŸ› ï¸ è€å¸«å‡ºé¡Œè¨­å®š</h2>
        
        <label>1. ä½œæ¥­æ¨™é¡Œ (ä¾‹å¦‚ï¼šç¬¬äº”èª² èª²å¾Œç·´ç¿’)</label>
        <input type="text" id="input-title" placeholder="è«‹è¼¸å…¥æ¨™é¡Œ...">
        
        <label>2. é¸æ“‡ä¸»é¡Œé¢¨æ ¼</label>
        <select id="input-theme" onchange="previewTheme()">
            <option value="theme-forest">ğŸŒ² æ£®æ—æ¢éšª (ç¶ è‰²)</option>
            <option value="theme-ocean">ğŸ³ æµ·æ´‹ä¸–ç•Œ (è—è‰²)</option>
            <option value="theme-candy">ğŸ­ ç³–æœæ¨‚åœ’ (ç²‰è‰²)</option>
        </select>

        <label>3. é é¦–åœ–ç‰‡ç¶²å€ (é¸å¡«ï¼Œå¯ç•™ç©º)</label>
        <input type="text" id="input-img" placeholder="è²¼ä¸Šåœ–ç‰‡é€£çµ (https://...)">

        <label>4. è¼¸å…¥é¡Œç›® (ä¸€è¡Œä¸€å¥ï¼Œç”¨ / åˆ‡å‰²)</label>
        <textarea id="input-sentences" placeholder="ç¯„ä¾‹ï¼š&#10;æˆ‘/æƒ³/å–/ä¸€æ¯/çç å¥¶èŒ¶/ã€‚&#10;è«‹å•/åœ–æ›¸é¤¨/åœ¨/å“ªè£¡/ï¼Ÿ"></textarea>
        
        <button class="btn btn-main" onclick="generateLink()">âœ¨ ç”¢ç”Ÿä½œæ¥­ç¶²å€</button>

        <div id="result-box" class="hidden" style="margin-top:20px; background:#f0f0f0; padding:15px; border-radius:10px;">
            <p>âœ… ç¶²å€å·²ç”Ÿæˆï¼è«‹è¤‡è£½å‚³çµ¦å­¸ç”Ÿï¼š</p>
            <textarea id="generated-link" style="height:60px; font-size:12px;" readonly></textarea>
            <button class="btn" style="background:#555;" onclick="copyLink()">ğŸ“‹ è¤‡è£½ç¶²å€</button>
            <button class="btn btn-main" onclick="testPlay()">ğŸ® ç«‹å³è©¦ç©</button>
        </div>
    </div>

    <div id="student-login" class="container hidden">
        <img id="login-img" class="hidden" src="" style="max-width:200px; border-radius:10px;">
        <h2 id="login-title">æ­¡è¿ä¾†åˆ°è½åŠ›ç·´ç¿’</h2>
        <p>è«‹è¼¸å…¥ä½ çš„åå­—é–‹å§‹æŒ‘æˆ°ï¼</p>
        <input type="text" id="student-name" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ / David" style="text-align:center; font-size:20px;">
        <br><br>
        <button class="btn btn-main" onclick="startQuiz()">ğŸš€ é–‹å§‹ç·´ç¿’</button>
    </div>

    <div id="game-area" class="container hidden">
        <div style="display:flex; justify-content:space-between; font-weight:bold; color:#666;">
            <span>ğŸ‘¤ <span id="display-name"></span></span>
            <span>ç¬¬ <span id="current-q">1</span> / <span id="total-q">10</span> é¡Œ</span>
        </div>
        <hr style="opacity:0.3; margin: 15px 0;">

        <img id="game-header-img" class="hidden" src="" style="max-height:150px; margin:0 auto; display:block;">

        <div style="margin: 20px 0;">
            <button class="btn btn-main" onclick="playAudio(1)">ğŸ”Š æ’­æ”¾</button>
            <button class="btn btn-main" style="opacity:0.8; transform:scale(0.9);" onclick="playAudio(0.7)">ğŸ¢ æ…¢é€Ÿ</button>
        </div>

        <p style="color:#555;">è«‹æ‹–æ›³å¡ç‰‡é‡çµ„å¥å­ï¼š</p>
        <div class="word-container" id="sortable-list"></div>

        <div id="feedback" style="font-size:20px; height:30px; font-weight:bold; margin:10px;"></div>
        
        <button class="btn" style="background:#ff9800;" onclick="checkAnswer()">âœ… æª¢æŸ¥ç­”æ¡ˆ</button>
        <button id="next-btn" class="btn btn-main hidden" onclick="nextQuestion()">ğŸ‘‰ ä¸‹ä¸€é¡Œ</button>
    </div>

    <div id="result-area" class="container hidden">
        <div class="certificate-box">
            <h2 style="color:#d32f2f; margin:0;">ğŸ† è½åŠ›ç·´ç¿’æˆç¸¾å–®</h2>
            <hr style="border: 1px solid #ddd; margin: 15px 0;">
            
            <h3 id="result-title-display">ä½œæ¥­æ¨™é¡Œ</h3>
            
            <p style="font-size:18px;">å§“åï¼š<strong id="result-name" style="font-size:24px; text-decoration:underline;"></strong></p>
            
            <div style="background:#f9f9f9; padding:20px; border-radius:15px; margin:20px 0;">
                <span style="font-size:16px; color:#666;">ç¸½åˆ†</span><br>
                <span id="final-score" style="font-size:60px; color:#2e7d32; font-weight:bold;">100</span>
                <span style="font-size:20px;">åˆ†</span>
            </div>

            <p style="color:#888; font-size:14px;">å®Œæˆæ—¥æœŸï¼š<span id="finish-date"></span></p>
            
            <div class="stamp">é€šé</div>
        </div>
        <br>
        <p>ğŸ‰ æ­å–œå®Œæˆï¼è«‹æˆªåœ–å‚³çµ¦è€å¸«ï¼</p>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let questions = [];
        let currentIdx = 0;
        let score = 0;
        let studentName = "";
        let pageSettings = { title: "è½åŠ›ç·´ç¿’", theme: "theme-forest", img: "" };

        // --- åˆå§‹åŒ–ï¼šåˆ¤æ–·æ˜¯è€å¸«é‚„æ˜¯å­¸ç”Ÿ ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const data = urlParams.get('q');

            if (data) {
                // æœ‰è³‡æ–™ -> å­¸ç”Ÿæ¨¡å¼
                try {
                    const decoded = JSON.parse(decodeURIComponent(atob(data)));
                    questions = decoded.q;
                    pageSettings = decoded.s || pageSettings; // è®€å–è¨­å®š
                    enterLoginMode();
                } catch (e) {
                    alert("é€£çµç„¡æ•ˆï¼Œè«‹ç¢ºèªç¶²å€å®Œæ•´æ€§ã€‚");
                }
            } else {
                // ç„¡è³‡æ–™ -> è€å¸«æ¨¡å¼
                document.getElementById('teacher-setup').classList.remove('hidden');
            }
        };

        // --- è€å¸«æ¨¡å¼åŠŸèƒ½ ---
        function previewTheme() {
            const theme = document.getElementById('input-theme').value;
            document.body.className = theme;
        }

        function generateLink() {
            const title = document.getElementById('input-title').value.trim() || "è½åŠ›ç·´ç¿’";
            const theme = document.getElementById('input-theme').value;
            const img = document.getElementById('input-img').value.trim();
            const rawText = document.getElementById('input-sentences').value.trim();

            if (!rawText) return alert("è«‹è¼¸å…¥é¡Œç›®ï¼");

            // è™•ç†é¡Œç›®
            const qList = [];
            const lines = rawText.split('\n');
            for (let line of lines) {
                line = line.trim();
                if (line) {
                    const chunks = line.split('/').map(w => w.trim()).filter(w => w);
                    if (chunks.length > 0) qList.push({ full: chunks.join(""), words: chunks });
                }
            }

            if (qList.length === 0) return alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç”¨ / åˆ†éš”è©å¡Š");

            // æ‰“åŒ…è³‡æ–™
            const pack = {
                s: { title: title, theme: theme, img: img }, // Settings
                q: qList // Questions
            };

            // åŠ å¯†ç¶²å€
            const jsonString = JSON.stringify(pack);
            const encoded = btoa(encodeURIComponent(jsonString));
            const finalUrl = `${window.location.href.split('?')[0]}?q=${encoded}`;

            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('generated-link').value = finalUrl;
        }

        function copyLink() {
            const copyText = document.getElementById("generated-link");
            copyText.select();
            document.execCommand("copy");
            alert("ç¶²å€å·²è¤‡è£½ï¼");
        }
        
        function testPlay() {
            window.location.href = document.getElementById("generated-link").value;
        }

        // --- å­¸ç”Ÿæ¨¡å¼åŠŸèƒ½ ---
        function enterLoginMode() {
            document.getElementById('teacher-setup').classList.add('hidden');
            document.getElementById('student-login').classList.remove('hidden');
            
            // æ‡‰ç”¨è¨­å®š
            document.body.className = pageSettings.theme;
            document.getElementById('main-title').innerText = pageSettings.title;
            document.getElementById('login-title').innerText = pageSettings.title;
            
            if(pageSettings.img) {
                const imgTag = document.getElementById('login-img');
                imgTag.src = pageSettings.img;
                imgTag.classList.remove('hidden');
            }
        }

        function startQuiz() {
            const nameInput = document.getElementById('student-name').value.trim();
            if (!nameInput) return alert("è«‹è¼¸å…¥åå­—å–”ï¼");
            
            studentName = nameInput;
            document.getElementById('display-name').innerText = studentName;
            
            document.getElementById('student-login').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            
            // éŠæˆ²å€åœ–ç‰‡
            if(pageSettings.img) {
                const gameImg = document.getElementById('game-header-img');
                gameImg.src = pageSettings.img;
                gameImg.classList.remove('hidden');
            }

            currentIdx = 0;
            score = 0;
            loadQuestion();
        }

        function loadQuestion() {
            document.getElementById('current-q').innerText = currentIdx + 1;
            document.getElementById('total-q').innerText = questions.length;
            const list = document.getElementById('sortable-list');
            const feedback = document.getElementById('feedback');
            const nextBtn = document.getElementById('next-btn');
            
            feedback.innerText = "";
            nextBtn.classList.add('hidden');
            list.innerHTML = "";

            // éš¨æ©Ÿæ’åˆ—
            let words = [...questions[currentIdx].words];
            words.sort(() => Math.random() - 0.5);

            words.forEach(word => {
                const item = document.createElement('div');
                item.classList.add('word-card');
                item.draggable = true;
                item.innerText = word;
                list.appendChild(item);
                addDragEvents(item);
            });
        }

        function playAudio(rate) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(questions[currentIdx].full);
                u.lang = 'zh-TW';
                u.rate = rate;
                window.speechSynthesis.speak(u);
            }
        }

        function checkAnswer() {
            // é˜²æ­¢é‡è¤‡æŒ‰
            if(!document.getElementById('next-btn').classList.contains('hidden')) return;

            const currentSentence = [...document.querySelectorAll('.word-card')].map(c => c.innerText).join("");
            const correct = questions[currentIdx].full;
            const feedback = document.getElementById('feedback');
            
            if (currentSentence === correct) {
                feedback.innerText = "ğŸ‰ ç­”å°äº†ï¼";
                feedback.style.color = "green";
                score++; // åŠ åˆ†
                document.getElementById('next-btn').classList.remove('hidden');
                
                // é–å®šå¡ç‰‡
                document.querySelectorAll('.word-card').forEach(c => {
                    c.style.background = "#dcedc8";
                    c.draggable = false;
                });
            } else {
                feedback.innerText = "âŒ å†è©¦è©¦çœ‹ï¼";
                feedback.style.color = "red";
                // é€™è£¡è¨­è¨ˆï¼šç­”éŒ¯ä¸æ‰£åˆ†ï¼Œä½†ä¸è®“ä½ éä¸‹ä¸€é¡Œï¼Œç›´åˆ°ç­”å°ï¼ˆä½†é€™æ¨£åˆ†æ•¸æ€éº¼ç®—ï¼Ÿ)
                // ä¿®æ­£ï¼šç­”éŒ¯é¡¯ç¤ºæç¤ºï¼Œå…è¨±é‡æ’ã€‚ç‚ºäº†è¨ˆç®—åˆ†æ•¸ï¼Œæˆ‘å€‘æ¡ç”¨ã€Œä¸€æ¬¡ç­”å°æ‰ç®—åˆ†ã€çš„é‚è¼¯ï¼Ÿ
                // ç‚ºäº†ç°¡å–®ï¼Œé€™è£¡æ¡ç”¨ï¼šç­”éŒ¯ä¸æ‰£åˆ†ï¼Œå¿…é ˆæ’å°æ‰èƒ½æŒ‰ä¸‹ä¸€é¡Œï¼Œä½†æœ€çµ‚åˆ†æ•¸è¨ˆç®—ç‚ºï¼š(ç¸½é¡Œæ•¸ - éŒ¯èª¤æ¬¡æ•¸)? 
                // ä¸ï¼Œæœ€ç°¡å–®çš„æ˜¯ï¼šå¿…é ˆç­”å°æ‰èƒ½ä¸‹ä¸€é¡Œã€‚åˆ†æ•¸è¨ˆç®—æˆ‘å€‘ç°¡å–®é»ï¼šåªè¦å®Œæˆäº†å°±æ˜¯100åˆ†ï¼Ÿ
                // è€å¸«çš„éœ€æ±‚æ˜¯è¨ˆåˆ†ã€‚é‚£æˆ‘å€‘æ”¹å€‹é‚è¼¯ï¼š
                // æŒ‰ä¸‹æª¢æŸ¥æ™‚ï¼Œå¦‚æœå…¨å° -> åŠ åˆ†ä¸¦é¡¯ç¤ºä¸‹ä¸€é¡Œã€‚
                // å¦‚æœéŒ¯ -> æç¤ºéŒ¯èª¤ï¼Œä¸åŠ åˆ†ï¼Œä½†å¿…é ˆæ”¹å°æ‰èƒ½ä¸‹ä¸€é¡Œ (é€™æ¨£æ‰æœ‰ç·´ç¿’æ•ˆæœ)ã€‚
                // é€™æ¨£åˆ†æ•¸åæ˜ çš„æ˜¯ã€Œä¸€æ¬¡å°±ç­”å°çš„é¡Œæ•¸ã€ã€‚
            }
        }
        
        // ä¿®æ­£ checkAnswer çš„è¨ˆåˆ†é‚è¼¯
        let hasTriedCurrent = false; // ç´€éŒ„ç•¶å‰é¡Œç›®æ˜¯å¦å˜—è©¦é
        
        // è¦†è“‹ä¸Šé¢çš„ checkAnswer ä»¥æ”¯æ´æ­£ç¢ºè¨ˆåˆ†
        checkAnswer = function() {
             const nextBtn = document.getElementById('next-btn');
             if(!nextBtn.classList.contains('hidden')) return; // å·²ç¶“ç­”å°é

             const currentSentence = [...document.querySelectorAll('.word-card')].map(c => c.innerText).join("");
             const correct = questions[currentIdx].full;
             const feedback = document.getElementById('feedback');

             if (currentSentence === correct) {
                 feedback.innerText = "ğŸ‰ ç­”å°äº†ï¼";
                 feedback.style.color = "green";
                 if (!hasTriedCurrent) score++; // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å˜—è©¦å°±å°ï¼Œæ‰åŠ åˆ†
                 
                 nextBtn.classList.remove('hidden');
                 document.querySelectorAll('.word-card').forEach(c => {
                     c.style.background = "#dcedc8";
                     c.draggable = false;
                 });
             } else {
                 feedback.innerText = "âŒ ä¸å°å–”ï¼Œå†è½ä¸€æ¬¡ï¼";
                 feedback.style.color = "#d32f2f";
                 hasTriedCurrent = true; // æ¨™è¨˜å·²å˜—è©¦éï¼ˆéŒ¯éï¼‰ï¼Œé€™é¡Œä¸æ‹¿åˆ†
             }
        }

        function nextQuestion() {
            currentIdx++;
            hasTriedCurrent = false; // é‡ç½®å˜—è©¦ç‹€æ…‹
            if (currentIdx < questions.length) {
                loadQuestion();
            } else {
                showResult();
            }
        }

        function showResult() {
            document.getElementById('game-area').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            
            // å¡«å¯«æˆç¸¾å–®
            document.getElementById('result-title-display').innerText = pageSettings.title;
            document.getElementById('result-name').innerText = studentName;
            
            // è¨ˆç®—ç™¾åˆ†æ¯”åˆ†æ•¸
            const finalScore = Math.round((score / questions.length) * 100);
            document.getElementById('final-score').innerText = finalScore;
            
            // æ—¥æœŸ
            const d = new Date();
            document.getElementById('finish-date').innerText = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
            
            // æ’­æ”¾ç…™ç«ç‰¹æ•ˆ (é¸ç”¨)
            // launchConfetti(); 
        }

        // --- æ‹–æ›³äº‹ä»¶ ---
        let draggedItem = null;
        function addDragEvents(item) {
            item.addEventListener('dragstart', () => { draggedItem = item; item.classList.add('dragging'); });
            item.addEventListener('dragend', () => { draggedItem = null; item.classList.remove('dragging'); });
            item.addEventListener('touchstart', handleTouchStart, {passive:false});
            item.addEventListener('touchmove', handleTouchMove, {passive:false});
            item.addEventListener('touchend', handleTouchEnd);
        }
        
        const list = document.getElementById('sortable-list');
        list.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(list, e.clientX);
            const draggable = document.querySelector('.dragging');
            if (draggable) {
                if (afterElement == null) list.appendChild(draggable);
                else list.insertBefore(draggable, afterElement);
            }
        });

        function getDragAfterElement(container, x) {
            const draggables = [...container.querySelectorAll('.word-card:not(.dragging)')];
            return draggables.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        let touchDragItem = null;
        function handleTouchStart(e) { touchDragItem = this; this.classList.add('dragging'); }
        function handleTouchMove(e) {
            e.preventDefault();
            const t = e.touches[0];
            const after = getDragAfterElement(list, t.clientX);
            if (after == null) list.appendChild(touchDragItem);
            else list.insertBefore(touchDragItem, after);
        }
        function handleTouchEnd() { this.classList.remove('dragging'); touchDragItem = null; }

    </script>
</body>
</html>