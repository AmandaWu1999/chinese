<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯èªè½åŠ›é‡çµ„ - è€å¸«å‡ºé¡Œç‰ˆ</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* é€šç”¨å®¹å™¨ */
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 95%; max-width: 800px; text-align: center; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { background-color: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 50px; font-size: 16px; cursor: pointer; margin: 5px; transition: 0.2s; }
        .btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .btn-blue { background-color: #2196F3; }
        .btn-orange { background-color: #FF9800; }
        .btn-gray { background-color: #777; font-size: 14px; padding: 8px 16px; }

        /* è€å¸«è¨­å®šå€æ¨£å¼ */
        #setup-area textarea { width: 100%; height: 200px; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; font-family: 'Microsoft JhengHei'; line-height: 1.5; }
        .instruction { text-align: left; background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #0d47a1; }
        
        /* éŠæˆ²å€æ¨£å¼ (é è¨­éš±è—) */
        #game-area { display: none; }
        .word-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 30px 0; min-height: 80px; padding: 20px; border: 2px dashed #bbb; border-radius: 10px; background-color: #fafafa; }
        .word-card { background: white; border: 1px solid #999; padding: 10px 20px; border-radius: 8px; cursor: grab; user-select: none; box-shadow: 0 3px 6px rgba(0,0,0,0.15); font-size: 20px; font-weight: bold; color: #333; touch-action: none; }
        .word-card:active { cursor: grabbing; background-color: #e8f5e9; transform: scale(0.98); }
        .word-card.dragging { opacity: 0.4; }
        
        #feedback { font-size: 20px; font-weight: bold; min-height: 30px; margin: 15px 0; }
        .progress { color: #666; margin-bottom: 10px; font-size: 18px; }

    </style>
</head>
<body>

    <div id="setup-area" class="container">
        <h2>âœï¸ è€å¸«å‡ºé¡Œè¨­å®šå€</h2>
        
        <div class="instruction">
            <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
            1. è«‹åœ¨ä¸‹æ–¹è¼¸å…¥å¥å­ï¼Œ<b>ä¸€è¡Œä¸€å¥</b>ã€‚<br>
            2. é‡è¦ï¼šè«‹ç”¨æ–œç·š <b>/</b> ä¾†åˆ‡å‰²è©å¡Šã€‚<br>
            <br>
            <em>ç¯„ä¾‹ï¼š<br>
            é›–ç„¶/ä»Šå¤©/ä¸‹é›¨/ï¼Œ/ä½†æ˜¯/æˆ‘å€‘/é‚„æ˜¯/å»/çˆ¬å±±/ã€‚<br>
            æˆ‘/è¦ºå¾—/ä¸­æ–‡/çš„/è²èª¿/å¾ˆ/é›£/ã€‚</em>
        </div>

        <textarea id="input-sentences" placeholder="è«‹åœ¨é€™è£¡è¼¸å…¥é¡Œç›®..."></textarea>
        <br><br>
        <button class="btn btn-blue" onclick="startGame()">ğŸš€ è¨­å®šå®Œæˆï¼Œé–‹å§‹ä¸Šèª² (Start)</button>
    </div>

    <div id="game-area" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button class="btn btn-gray" onclick="backToSetup()">âš™ï¸ å›è¨­å®š</button>
            <div class="progress">ç¬¬ <span id="current-q">1</span> / <span id="total-q">1</span> é¡Œ</div>
        </div>
        
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

        <button class="btn btn-blue" onclick="playAudio(1)">ğŸ”Š æ­£å¸¸é€Ÿåº¦ (Normal)</button>
        <button class="btn btn-blue" onclick="playAudio(0.7)">ğŸ¢ æ…¢é€Ÿæ’­æ”¾ (Slow)</button>

        <p style="color:#555;">è«‹æ‹–æ›³å¡ç‰‡é‡çµ„å¥å­ï¼š</p>

        <div class="word-container" id="sortable-list"></div>

        <div id="feedback"></div>

        <button class="btn" onclick="checkAnswer()">âœ… æª¢æŸ¥ç­”æ¡ˆ</button>
        <button class="btn btn-orange" onclick="nextQuestion()" id="next-btn" style="display:none;">ğŸ‘‰ ä¸‹ä¸€é¡Œ</button>
    </div>

    <script>
        let questions = [];
        let currentIdx = 0;
        const setupArea = document.getElementById('setup-area');
        const gameArea = document.getElementById('game-area');
        const list = document.getElementById('sortable-list');
        const feedback = document.getElementById('feedback');
        const nextBtn = document.getElementById('next-btn');
        const inputArea = document.getElementById('input-sentences');

        // é è¨­çµ¦è€å¸«ä¸€å€‹ç¯„ä¾‹
        inputArea.value = "æ­¡è¿/ä½¿ç”¨/é€™å€‹/è½åŠ›/ç·´ç¿’/ç¶²ç«™/ï¼\nè«‹/è€å¸«/åœ¨/è¨­å®šé é¢/è¼¸å…¥/å¥å­/ã€‚";

        // --- è€å¸«æ¨¡å¼é‚è¼¯ ---

        function startGame() {
            const rawText = inputArea.value.trim();
            if (!rawText) {
                alert("è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹å¥å­å–”ï¼");
                return;
            }

            // è§£æè€å¸«è¼¸å…¥çš„æ–‡å­—
            const lines = rawText.split('\n');
            questions = []; // æ¸…ç©ºèˆŠé¡Œç›®

            for (let line of lines) {
                line = line.trim();
                if (line) {
                    // æŠŠ "æˆ‘/è¦ºå¾—/å¥½" è®Šæˆ ["æˆ‘", "è¦ºå¾—", "å¥½"]
                    const chunks = line.split('/').map(w => w.trim()).filter(w => w);
                    if (chunks.length > 0) {
                        questions.push({
                            fullSentence: chunks.join(""), // æ‹¼å›å»è®Šæˆå®Œæ•´å¥å­çµ¦èªéŸ³å”¸
                            words: chunks // åˆ‡å‰²å¥½çš„è©å¡Šé™£åˆ—
                        });
                    }
                }
            }

            if (questions.length === 0) return;

            // åˆ‡æ›ç•«é¢
            setupArea.style.display = 'none';
            gameArea.style.display = 'block';
            currentIdx = 0;
            loadQuestion();
        }

        function backToSetup() {
            if(confirm("ç¢ºå®šè¦å›åˆ°è¨­å®šé é¢å—ï¼Ÿç›®å‰çš„é€²åº¦æœƒæ¶ˆå¤±å–”ã€‚")) {
                gameArea.style.display = 'none';
                setupArea.style.display = 'block';
            }
        }

        // --- å­¸ç”Ÿæ¨¡å¼é‚è¼¯ ---

        function loadQuestion() {
            document.getElementById('current-q').innerText = currentIdx + 1;
            document.getElementById('total-q').innerText = questions.length;
            feedback.innerText = "";
            feedback.style.color = "#333";
            nextBtn.style.display = "none";
            list.innerHTML = "";

            // éš¨æ©Ÿæ‰“äº‚è©å¡Š
            let shuffledWords = [...questions[currentIdx].words];
            shuffledWords.sort(() => Math.random() - 0.5);

            shuffledWords.forEach(word => {
                const item = document.createElement('div');
                item.classList.add('word-card');
                item.draggable = true;
                item.innerText = word;
                list.appendChild(item);

                // è¨»å†Šæ‹–æ›³äº‹ä»¶ (Desktop & Mobile)
                addDragEvents(item);
            });
        }

        // æ’­æ”¾èªéŸ³
        function playAudio(rate) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const text = questions[currentIdx].fullSentence; // å”¸å®Œæ•´å¥å­
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = rate;
                window.speechSynthesis.speak(utterance);
            } else {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æ’­æ”¾");
            }
        }

        function checkAnswer() {
            const currentWords = [...list.querySelectorAll('.word-card')].map(card => card.innerText);
            const studentSentence = currentWords.join("");
            const correctSentence = questions[currentIdx].fullSentence;

            if (studentSentence === correctSentence) {
                feedback.innerText = "ğŸ‰ å¤ªæ£’äº†ï¼ç­”å°äº†ï¼";
                feedback.style.color = "green";
                nextBtn.style.display = "inline-block";
                
                // ç­”å°æ™‚é–å®šå¡ç‰‡ä¸è®“ç§»å‹•
                list.querySelectorAll('.word-card').forEach(c => {
                    c.style.backgroundColor = "#e8f5e9";
                    c.style.borderColor = "#4CAF50";
                    c.draggable = false;
                });

            } else {
                feedback.innerText = "âŒ é †åºä¸å¤ªå°ï¼Œå†è½ä¸€æ¬¡è©¦è©¦çœ‹ï¼Ÿ";
                feedback.style.color = "#e53935";
            }
        }

        function nextQuestion() {
            currentIdx++;
            if (currentIdx < questions.length) {
                loadQuestion();
            } else {
                alert("æ­å–œï¼æ‰€æœ‰é¡Œç›®éƒ½ç·´ç¿’å®Œäº†ï¼");
                backToSetup(); // å›åˆ°é¦–é 
            }
        }

        // --- æ‹–æ›³åŠŸèƒ½æ ¸å¿ƒ (æ”¯æ´æ‰‹æ©Ÿè§¸æ§) ---
        let draggedItem = null;

        function addDragEvents(item) {
            // é›»è…¦ç‰ˆ Mouse Events
            item.addEventListener('dragstart', () => { draggedItem = item; item.classList.add('dragging'); });
            item.addEventListener('dragend', () => { draggedItem = null; item.classList.remove('dragging'); });

            // æ‰‹æ©Ÿç‰ˆ Touch Events (ç°¡å–®å¯¦ä½œ)
            item.addEventListener('touchstart', handleTouchStart, {passive: false});
            item.addEventListener('touchmove', handleTouchMove, {passive: false});
            item.addEventListener('touchend', handleTouchEnd);
        }

        // è™•ç†æ”¾ç½®å€çš„é‚è¼¯
        list.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(list, e.clientX, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (draggable) {
                if (afterElement == null) {
                    list.appendChild(draggable);
                } else {
                    list.insertBefore(draggable, afterElement);
                }
            }
        });

        function getDragAfterElement(container, x, y) {
            const draggableElements = [...container.querySelectorAll('.word-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                // ç°¡å–®åˆ¤æ–·ï¼šä»¥ X è»¸ç‚ºä¸»ï¼ŒY è»¸è¼”åŠ©
                const offsetX = x - box.left - box.width / 2;
                const offsetY = y - box.top - box.height / 2;
                
                // æˆ‘å€‘ä¸»è¦çœ‹æ˜¯å¦åœ¨è©²å…ƒç´ å·¦é‚Š (offsetX < 0) ä¸”è·é›¢æœ€è¿‘
                if (offsetX < 0 && offsetX > closest.offset) {
                    return { offset: offsetX, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- æ‰‹æ©Ÿè§¸æ§æ‹–æ›³æ”¯æ´ (é€²éš) ---
        // ç‚ºäº†è®“æ‰‹æ©Ÿä¹Ÿèƒ½ç©ï¼Œé€™è£¡ç”¨äº†æ¯”è¼ƒåŸç”Ÿçš„æ–¹å¼æ¨¡æ“¬æ‹–æ›³
        // (è¨»ï¼šçœŸæ­£å®Œç¾çš„è§¸æ§æ‹–æ›³é€šå¸¸éœ€è¦å¼•ç”¨å¤–éƒ¨å‡½å¼åº«ï¼Œé€™è£¡æä¾›åŸºç¤ç‰ˆ)
        let touchDragItem = null;

        function handleTouchStart(e) {
            touchDragItem = this;
            this.classList.add('dragging');
        }

        function handleTouchMove(e) {
            e.preventDefault(); // é˜²æ­¢ç•«é¢æ²å‹•
            const touch = e.touches[0];
            const afterElement = getDragAfterElement(list, touch.clientX, touch.clientY);
            
            if (afterElement == null) {
                list.appendChild(touchDragItem);
            } else {
                list.insertBefore(touchDragItem, afterElement);
            }
        }

        function handleTouchEnd(e) {
            this.classList.remove('dragging');
            touchDragItem = null;
        }

    </script>
</body>
</html>