<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥çœ‹åœ–è½åŠ› V3.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root { --bg: #f4f4f4; --card: #fff; --primary: #555; --text: #333; --border: #ccc; --radius: 12px; --font: 'Microsoft JhengHei', sans-serif; }
        body { margin: 0; padding: 20px; padding-bottom: 60px; font-family: var(--font); background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; transition: 0.3s; }
        .container { background: var(--card); padding: 30px; width: 95%; max-width: 700px; border-radius: var(--radius); border: 2px solid var(--border); box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; }
        .btn { background: var(--primary); color: #fff; border: none; padding: 12px 24px; border-radius: 50px; cursor: pointer; font-size: 16px; margin: 8px; font-family: inherit; transition: 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .btn:hover { filter: brightness(1.1); }
        .btn-upload { background: #00897B; font-size: 14px; padding: 8px 15px; }
        .btn-tiny { background: #E91E63; } /* ç¸®ç¶²å€æŒ‰éˆ•é¡è‰² */
        
        input[type="text"], select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-size: 15px; }

        /* é¡Œç›®å€ */
        .q-block { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed var(--border); }
        .q-block h3 { margin: 0 0 10px 0; color: var(--primary); }
        .img-control-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .preview-thumb { width: 60px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; display: none; background: #eee; }
        .option-row { display: flex; gap: 10px; align-items: center; }

        /* å­¸ç”Ÿå€ */
        .quiz-image-box { width: 100%; height: 250px; background: #eee; border-radius: var(--radius); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid var(--primary); }
        .quiz-image-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; width: 100%; margin-top: 20px; }
        .option-btn { background: #fff; border: 2px solid var(--primary); color: var(--text); padding: 15px; border-radius: 10px; font-size: 18px; cursor: pointer; transition: 0.2s; text-align: left; }
        .option-btn.correct { background: #C8E6C9; border-color: #4CAF50; color: #2E7D32; }
        .option-btn.wrong { background: #FFCDD2; border-color: #F44336; color: #C62828; }

        .footer-credit { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); text-align: center; padding: 10px 0; font-size: 14px; color: #666; border-top: 1px solid #ddd; z-index: 999; }
        .footer-credit span { font-weight: bold; color: #333; }
        
        /* é¢¨æ ¼ */
        body.style-morandi { --bg: #D8E2DC; --card: #F9F7F2; --primary: #9D8189; --text: #6D6875; --border: #B5B2BE; --radius: 12px; }
        body.style-wood { --bg: #EFEBE9; --card: #FFF3E0; --primary: #8D6E63; --text: #3E2723; --border: #D7CCC8; --radius: 8px; background-image: repeating-linear-gradient(45deg, #EFEBE9 0, #EFEBE9 10px, #D7CCC8 10px, #D7CCC8 12px); }
        body.style-tech { --bg: #ECEFF1; --card: #FFF; --primary: #0097A7; --text: #37474F; --border: #B2EBF2; --radius: 4px; }
        body.style-sky { --bg: #E1F5FE; --card: #FFF; --primary: #4FC3F7; --text: #0277BD; --border: #B3E5FC; --radius: 20px; background-image: radial-gradient(#FFF 20%, transparent 20%); background-size: 20px 20px; }
        body.style-chalk { --bg: #263238; --card: #37474F; --primary: #FFCC80; --text: #FFF; --border: #546E7A; --radius: 6px; }
        body.style-chalk input { background: #455A64; color: white; border: 1px solid #78909C; }
        body.style-chalk .option-btn { background: transparent; color: white; border-color: #FFCC80; }

        .hidden { display: none !important; }
        .stamp { position: absolute; right: 20px; bottom: 20px; font-size: 40px; border: 3px solid #D32F2F; color: #D32F2F; padding: 15px; transform: rotate(-15deg); border-radius: 50%; opacity: 0.8; font-weight: bold; background: rgba(255,255,255,0.8); }
        
        /* è¼‰å…¥ä¸­é®ç½© */
        #loading-mask { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:flex; justify-content:center; align-items:center; color:white; font-size:20px; }
    </style>
</head>
<body class="style-morandi">

    <div id="loading-mask" class="hidden">ğŸ”„ æ­£åœ¨è™•ç†åœ–ç‰‡ä¸¦ç”¢ç”Ÿç¶²å€...</div>
    <div class="footer-credit">Designed by <span>å°å¸«å¤§å³ç©ç´”è€å¸«</span> | Powered by AI Tool</div>
    <h1 id="page-title">ğŸ“· æ¯æ—¥çœ‹åœ–è½åŠ› V3</h1>

    <div id="teacher-setup" class="container">
        <h2>âœï¸ è€å¸«å‡ºé¡Œ (è‡ªå‹•ç¸®å€ç‰ˆ)</h2>
        <label>1. é¸æ“‡é¢¨æ ¼</label>
        <select id="input-style" onchange="previewStyle()">
            <option value="style-morandi">1. è«è˜­è¿ª Morandi</option>
            <option value="style-wood">2. æº«æš–æœ¨è³ª Wood</option>
            <option value="style-tech">3. ç§‘æŠ€è—èª¿ Tech</option>
            <option value="style-sky">4. å¯æ„›å¤©ç©º Sky</option>
            <option value="style-chalk">5. æ•™å®¤é»‘æ¿ Chalkboard</option>
        </select>
        <label>2. ä½œæ¥­æ¨™é¡Œ</label>
        <input type="text" id="input-title" placeholder="ä¾‹å¦‚ï¼š11/26 æ¯æ—¥è½åŠ›ç·´ç¿’">
        <hr style="border:0; border-top:1px dashed var(--border); margin:20px 0;">
        
        <div id="questions-wrapper"></div>

        <button class="btn" onclick="generateLink()">âœ¨ ç”¢ç”Ÿä½œæ¥­é€£çµ</button>

        <div id="result-box" class="hidden" style="margin-top:20px; padding:15px; border:1px solid var(--border); background: rgba(255,255,255,0.5);">
            <p id="url-status">âœ… ç¶²å€å·²ç”Ÿæˆ (åŸå§‹ç¶²å€)ï¼š</p>
            <textarea id="generated-link" style="height:60px; font-size:12px;" readonly></textarea>
            
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" onclick="copyLink()">ğŸ“‹ è¤‡è£½ç¶²å€</button>
                <button class="btn btn-tiny" onclick="tryAutoShorten()">ğŸª„ å˜—è©¦è‡ªå‹•ç¸®çŸ­ (TinyURL)</button>
                <button class="btn" onclick="testPlay()">ğŸ® è©¦ç©</button>
            </div>
            <p style="font-size:12px; color:#666; margin-top:5px;">* å¦‚æœç¶²å€å¤ªé•·å°è‡´ç„¡æ³•åˆ†äº«ï¼Œè«‹æŒ‰ã€Œå˜—è©¦è‡ªå‹•ç¸®çŸ­ã€ã€‚</p>
        </div>
    </div>

    <div id="student-login" class="container hidden" style="text-align:center;">
        <h2 id="login-title">æº–å‚™é–‹å§‹</h2>
        <p>è«‹è¼¸å…¥åå­—ï¼š</p>
        <input type="text" id="student-name" placeholder="Name" style="text-align:center; font-size:18px;">
        <br><br>
        <button class="btn" onclick="startQuiz()">ğŸš€ é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="game-area" class="container hidden">
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span id="display-name"></span>
            <span>ç¬¬ <span id="current-q">1</span> / 5 é¡Œ</span>
        </div>
        <hr style="border-top: 1px solid var(--border); margin: 15px 0;">
        <div class="quiz-image-box">
            <img id="q-img" src="" alt="é¡Œç›®åœ–ç‰‡">
        </div>
        <div style="text-align:center;">
            <button class="btn" onclick="playAudio(1)">ğŸ”Š æ’­æ”¾</button>
            <button class="btn" style="opacity:0.8; font-size:14px;" onclick="playAudio(0.7)">ğŸ¢ æ…¢é€Ÿ</button>
        </div>
        <div class="options-grid" id="options-area"></div>
        <div id="feedback" style="text-align:center; height:30px; margin-top:10px; font-weight:bold;"></div>
    </div>

    <div id="result-area" class="container hidden" style="text-align:center;">
        <div style="font-size:80px; margin-bottom:10px;">ğŸ†</div>
        <h2>å®Œæˆï¼Excellent!</h2>
        <h3 id="result-title-display"></h3>
        <p>å§“åï¼š<strong id="result-name" style="font-size:24px;"></strong></p>
        <div style="font-size:60px; font-weight:bold; color:var(--primary); margin:20px;">
            <span id="final-score">100</span> <span style="font-size:20px;">åˆ†</span>
        </div>
        <p>æ—¥æœŸï¼š<span id="finish-date"></span></p>
        <div class="stamp">å°å¸«å¤§èªè­‰</div>
        <p style="color:var(--primary); font-size:14px;">(è«‹æˆªåœ–å›å‚³)</p>
    </div>

    <script>
        const totalQuestions = 5;
        let questionsData = [];
        let currentIdx = 0;
        let score = 0;
        let studentName = "";
        let settings = { title: "çœ‹åœ–è½åŠ›", style: "style-morandi" };
        const correctSound = new Audio('https://raw.githubusercontent.com/Arza-3d/ar3.js/master/assets/audio/success.mp3');
        const victorySound = new Audio('https://raw.githubusercontent.com/Arza-3d/ar3.js/master/assets/audio/victory.mp3');

        // --- 1. ç”¢ç”Ÿé¡Œç›®æ¡† ---
        window.addEventListener('DOMContentLoaded', () => {
            const wrapper = document.getElementById('questions-wrapper');
            if (wrapper) {
                for (let i = 1; i <= totalQuestions; i++) {
                    wrapper.innerHTML += `
                        <div class="q-block">
                            <h3>ç¬¬ ${i} é¡Œ</h3>
                            <div class="img-control-row">
                                <button class="btn btn-upload" onclick="document.getElementById('file-${i}').click()">ğŸ“‚ é¸æ“‡æª”æ¡ˆ</button>
                                <input type="file" id="file-${i}" accept="image/*" style="display:none" onchange="handleFileUpload(this, ${i})">
                                <span style="font-size:14px; color:#666;">æˆ–</span>
                                <input type="text" id="url-${i}" class="input-img" style="flex:1;" placeholder="è²¼ä¸Šåœ–ç‰‡ç¶²å€...">
                                <img id="preview-${i}" class="preview-thumb">
                            </div>
                            <input type="text" class="input-text" placeholder="è½åŠ›æ–‡ç¨¿ (ä¾‹å¦‚ï¼šé€™æ˜¯ä¸€éš»è²“)">
                            <div style="margin-top:5px;">
                                <div class="option-row"><input type="radio" name="q${i}" value="0" checked> <input type="text" class="opt-0" placeholder="é¸é … A"></div>
                                <div class="option-row"><input type="radio" name="q${i}" value="1"> <input type="text" class="opt-1" placeholder="é¸é … B"></div>
                                <div class="option-row"><input type="radio" name="q${i}" value="2"> <input type="text" class="opt-2" placeholder="é¸é … C"></div>
                            </div>
                        </div>
                    `;
                }
            }
            checkUrlData();
        });

        // --- 2. å¼·åŠ›åœ–ç‰‡å£“ç¸® (V3 æ ¸å¿ƒ) ---
        function handleFileUpload(input, index) {
            const file = input.files[0];
            if(!file) return;
            
            document.getElementById('loading-mask').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    // é™åˆ¶æœ€å¤§å¯¬åº¦ç‚º 250px (å¤§å¹…æ¸›å°‘é«”ç©)
                    const maxWidth = 250;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // ä½¿ç”¨ JPEG æ ¼å¼ï¼Œå“è³ªå£“ç¸®åˆ° 0.5
                    const compressedData = canvas.toDataURL('image/jpeg', 0.5);
                    
                    document.getElementById(`url-${index}`).value = compressedData;
                    const thumb = document.getElementById(`preview-${index}`);
                    thumb.src = compressedData;
                    thumb.style.display = "block";
                    
                    document.getElementById('loading-mask').classList.add('hidden');
                }
            }
            reader.readAsDataURL(file);
        }

        function previewStyle() { document.body.className = document.getElementById('input-style').value; }

        function generateLink() {
            const title = document.getElementById('input-title').value.trim() || "æ¯æ—¥è½åŠ›";
            const style = document.getElementById('input-style').value;
            const qBlocks = document.querySelectorAll('.q-block');
            
            let qList = [];
            qBlocks.forEach((block, idx) => {
                const img = block.querySelector('.input-img').value.trim();
                const text = block.querySelector('.input-text').value.trim();
                const opts = [
                    block.querySelector('.opt-0').value.trim(),
                    block.querySelector('.opt-1').value.trim(),
                    block.querySelector('.opt-2').value.trim()
                ];
                const correct = block.querySelector(`input[name="q${idx+1}"]:checked`).value;
                if (text && opts[0]) qList.push({ img, text, opts, correct: parseInt(correct) });
            });

            if (qList.length < 1) return alert("è«‹è‡³å°‘è¼¸å…¥ä¸€é¡Œ");

            const pack = { s: { title, style }, q: qList };
            const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(pack));
            const url = `${window.location.href.split('?')[0]}?data=${compressed}`;
            
            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('generated-link').value = url;
            document.getElementById('url-status').innerText = "âœ… ç¶²å€å·²ç”Ÿæˆ (åŸå§‹é•·ç¶²å€)ï¼š";
        }

        // --- 3. è‡ªå‹•ç¸®ç¶²å€ (TinyURL API) ---
        function tryAutoShorten() {
            const longUrl = document.getElementById('generated-link').value;
            if(!longUrl) return;

            const btn = document.querySelector('.btn-tiny');
            btn.innerText = "â³ è™•ç†ä¸­...";
            btn.disabled = true;

            // å˜—è©¦ä½¿ç”¨ fetch å‘¼å« TinyURL
            fetch('https://tinyurl.com/api-create.php?url=' + encodeURIComponent(longUrl))
            .then(response => {
                if (response.ok) return response.text();
                throw new Error('Network response was not ok.');
            })
            .then(shortUrl => {
                document.getElementById('generated-link').value = shortUrl;
                document.getElementById('url-status').innerText = "âœ¨ æˆåŠŸï¼é€™æ˜¯æ‚¨çš„çŸ­ç¶²å€ï¼š";
                btn.innerText = "âœ… æˆåŠŸç¸®çŸ­";
                alert("ç¸®ç¶²å€æˆåŠŸï¼ç¾åœ¨å¯ä»¥ç›´æ¥è¤‡è£½ä½¿ç”¨äº†ã€‚");
            })
            .catch(error => {
                console.error('ç¸®ç¶²å€å¤±æ•—:', error);
                btn.innerText = "âŒ è‡ªå‹•ç¸®çŸ­å¤±æ•—";
                // å¤±æ•—æ™‚æä¾›å‚™ç”¨æ–¹æ¡ˆ
                if(confirm("è‡ªå‹•ç¸®çŸ­å¤±æ•— (å¯èƒ½æ˜¯ç¶²å€å¤ªé•·æˆ–ç¶²è·¯å•é¡Œ)ã€‚\n\næ˜¯å¦è¦é–‹å•Ÿ TinyURL ç¶²ç«™æ‰‹å‹•ç¸®çŸ­ï¼Ÿ\n(æˆ‘æœƒå…ˆå¹«æ‚¨è¤‡è£½å¥½ç¶²å€)")) {
                    copyLink();
                    window.open("https://tinyurl.com/app", "_blank");
                }
            });
        }

        function copyLink() {
            const text = document.getElementById('generated-link');
            text.select();
            document.execCommand('copy');
            alert("ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
        }
        function testPlay() { window.location.href = document.getElementById('generated-link').value; }

        // --- å­¸ç”Ÿç«¯é‚è¼¯ ---
        function checkUrlData() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('data');
            if (data) {
                try {
                    const decoded = JSON.parse(LZString.decompressFromEncodedURIComponent(data));
                    questionsData = decoded.q;
                    settings = decoded.s;
                    enterStudentMode();
                } catch (e) { console.error(e); }
            } else {
                document.getElementById('teacher-setup').classList.remove('hidden');
                previewStyle();
            }
        }

        function enterStudentMode() {
            document.getElementById('teacher-setup').classList.add('hidden');
            document.getElementById('student-login').classList.remove('hidden');
            document.body.className = settings.style;
            document.getElementById('login-title').innerText = settings.title;
        }

        function startQuiz() {
            const n = document.getElementById('student-name').value.trim();
            if (!n) return alert("è«‹è¼¸å…¥åå­—");
            studentName = n;
            document.getElementById('student-login').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('display-name').innerText = n;
            currentIdx = 0; score = 0; loadQuestion();
        }

        function loadQuestion() {
            if (currentIdx >= questionsData.length) { showResult(); return; }
            const q = questionsData[currentIdx];
            document.getElementById('current-q').innerText = currentIdx + 1;
            document.getElementById('q-img').src = q.img || "https://via.placeholder.com/400x250?text=No+Image";
            const area = document.getElementById('options-area');
            area.innerHTML = "";
            document.getElementById('feedback').innerText = "";
            q.opts.forEach((optText, idx) => {
                if(!optText) return; 
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = optText;
                btn.onclick = () => checkAnswer(idx, btn);
                area.appendChild(btn);
            });
        }

        function playAudio(rate) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(questionsData[currentIdx].text);
            u.lang = 'zh-TW'; u.rate = rate;
            window.speechSynthesis.speak(u);
        }

        let isAnswered = false;
        function checkAnswer(selectedIdx, btnElement) {
            if (isAnswered) return;
            isAnswered = true;
            const q = questionsData[currentIdx];
            if (selectedIdx === q.correct) {
                btnElement.classList.add('correct');
                document.getElementById('feedback').innerText = "ğŸ‰ ç­”å°äº†ï¼";
                document.getElementById('feedback').style.color = "green";
                score += 20;
                correctSound.currentTime = 0; correctSound.play();
            } else {
                btnElement.classList.add('wrong');
                document.getElementById('feedback').innerText = "âŒ ç­”éŒ¯äº†ï¼";
                document.getElementById('feedback').style.color = "red";
                document.querySelectorAll('.option-btn')[q.correct].classList.add('correct');
            }
            setTimeout(() => { currentIdx++; isAnswered = false; loadQuestion(); }, 2000);
        }

        function showResult() {
            document.getElementById('game-area').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('result-title-display').innerText = settings.title;
            document.getElementById('result-name').innerText = studentName;
            document.getElementById('final-score').innerText = Math.round((score / (questionsData.length * 20)) * 100);
            const d = new Date();
            document.getElementById('finish-date').innerText = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
            victorySound.play();
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }
    </script>
</body>
</html>
