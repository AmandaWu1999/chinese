<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè©å¤§å¯Œç¿ - è±ªè¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* å­—é«”èˆ‡å‹•ç•«è¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=ZCOOL+KuaiLe&display=swap');
        @keyframes pop { 0% { transform: scale(0.9); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        body { font-family: 'Noto Sans TC', sans-serif; transition: background 0.5s ease; }
        
        /* ç½²åæµ®æ°´å° */
        .credit-footer {
            position: fixed; bottom: 8px; right: 12px; font-size: 0.75rem; 
            color: rgba(0,0,0,0.5); pointer-events: none; z-index: 9999;
            background: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 4px;
        }
        .theme-geometric .credit-footer { color: rgba(255,255,255,0.5); background: rgba(0,0,0,0.7); }

        /* éŠæˆ²ç›¤ä½ˆå±€ */
        .board-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 4px;
            width: 100%; max-width: 800px; aspect-ratio: 1/1; margin: 0 auto;
        }
        .cell {
            position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 6px; font-size: 0.75rem; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 2px; text-align: center;
        }
        .center-area {
            grid-column: 2 / 8; grid-row: 2 / 8; display: flex; flex-direction: column; justify-content: center;
            align-items: center; background: rgba(255,255,255,0.85); border-radius: 12px; padding: 20px; z-index: 10;
        }
        /* ç©å®¶æ£‹å­ (ç¾åœ¨æ˜¯é ­åƒ) */
        .token {
            width: 28px; height: 28px; border-radius: 50%; position: absolute; z-index: 20;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center; font-size: 16px; background: white;
            transition: all 0.5s ease-in-out;
        }
        .token.p1 { top: -5px; left: -5px; border-color: #ef4444; }
        .token.p2 { bottom: -5px; right: -5px; border-color: #3b82f6; }
        .owner-mark {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 3px solid transparent; border-radius: 6px; pointer-events: none;
        }

        /* --- é¢¨æ ¼ä¸»é¡Œè®Šæ•¸ (ç°¡åŒ–ç‰ˆ) --- */
        .theme-morandi { background-color: #e8e6e1; color: #5e5e5e; } .theme-morandi .cell { background: #d6cfc7; }
        .theme-chalkboard { background-color: #2b3a42; color: #eee; font-family: 'ZCOOL KuaiLe'; } .theme-chalkboard .cell { background: #3e505b; border: 1px dashed #777; color:white;}
        .theme-flat { background-color: #f3f4f6; } .theme-flat .cell { background: white; border: 2px solid #e5e7eb; }
        .theme-watercolor { background: linear-gradient(135deg, #fdfbfb, #ebedee); } .theme-watercolor .cell { background: rgba(255,255,255,0.7); border-radius: 12px 4px; }
        .theme-chibi { background-color: #fff1f2; font-family: 'ZCOOL KuaiLe'; } .theme-chibi .cell { background: #ffe4e6; border: 3px solid #fda4af; border-radius: 15px; }
        .theme-geometric { background-color: #111827; color: #d1d5db; } .theme-geometric .cell { background: #1f2937; border: 1px solid #374151; }

        /* Modal Overlay */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 420px;
            text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); animation: pop 0.3s; color: #333;
        }
    </style>
</head>
<body class="theme-flat h-screen flex flex-col items-center overflow-hidden bg-gray-100">

    <div class="credit-footer">æä¾›è€…: å°å¸«å¤§å³ç©ç´”è€å¸«</div>

    <div id="setup-screen" class="w-full h-full absolute top-0 left-0 bg-white z-50 flex flex-col items-center justify-start p-4 overflow-y-auto font-sans text-gray-800">
        <div class="max-w-2xl w-full space-y-5 my-4">
            <h1 class="text-3xl font-bold text-center text-blue-600">ğŸ² ç”Ÿè©å¤§å¯Œç¿ (è±ªè¯ç‰ˆ)</h1>
            
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                <h2 class="font-bold text-lg">1. ç©å®¶è¨­å®š</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-lg border">
                        <label class="block text-sm font-bold text-red-600 mb-1">ç©å®¶ 1 (P1)</label>
                        <input type="text" id="p1-name" value="è€å¸«" class="w-full border p-1 rounded mb-2 text-sm" placeholder="è¼¸å…¥åå­—">
                        <label class="block text-xs text-gray-500 mb-1">é¸æ“‡é ­åƒ</label>
                        <select id="p1-avatar" class="w-full border p-1 rounded text-xl">
                            <option value="ğŸ‘©â€ğŸ«" selected>ğŸ‘©â€ğŸ« è€å¸«A</option>
                            <option value="ğŸ¦">ğŸ¦ ç…å­</option>
                            <option value="ğŸ¤–">ğŸ¤– æ©Ÿå™¨äºº</option>
                            <option value="ğŸ¦¸â€â™€ï¸">ğŸ¦¸â€â™€ï¸ å¥³è¶…äºº</option>
                            <option value="ğŸ±">ğŸ± è²“å’ª</option>
                        </select>
                    </div>
                    <div class="bg-white p-3 rounded-lg border">
                        <label class="block text-sm font-bold text-blue-600 mb-1">ç©å®¶ 2 (P2)</label>
                        <input type="text" id="p2-name" value="å­¸ç”Ÿ" class="w-full border p-1 rounded mb-2 text-sm" placeholder="è¼¸å…¥åå­—">
                        <label class="block text-xs text-gray-500 mb-1">é¸æ“‡é ­åƒ</label>
                        <select id="p2-avatar" class="w-full border p-1 rounded text-xl">
                            <option value="ğŸ‘¨â€ğŸ“" selected>ğŸ‘¨â€ğŸ“ å­¸ç”ŸB</option>
                            <option value="ğŸ¦Š">ğŸ¦Š ç‹ç‹¸</option>
                            <option value="ğŸš€">ğŸš€ ç«ç®­</option>
                            <option value="ğŸ§™â€â™‚ï¸">ğŸ§™â€â™‚ï¸ æ³•å¸«</option>
                             <option value="ğŸ¶">ğŸ¶ ç‹—ç‹—</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-3">
                <h2 class="font-bold text-lg">2. éŠæˆ²è¨­å®š</h2>
                <div>
                    <label class="block text-sm text-gray-700 mb-1">é¸æ“‡é¢¨æ ¼ä¸»é¡Œ</label>
                    <select id="theme-select" class="w-full p-2 border border-gray-300 rounded mb-2">
                        <option value="theme-flat">æ‰å¹³æ’ç•«é¢¨ (Flat)</option>
                        <option value="theme-morandi">è«è˜­è¿ªç²‰å½© (Morandi)</option>
                        <option value="theme-watercolor">æ°´å½©æ¸²æŸ“é¢¨ (Watercolor)</option>
                        <option value="theme-chalkboard">æ•™å®¤é»‘æ¿é¢¨ (Chalkboard)</option>
                        <option value="theme-chibi">Q ç‰ˆå¯æ„›é¢¨ (Chibi)</option>
                        <option value="theme-geometric">æš—é»‘å¹¾ä½•é¢¨ (Geometric)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-700 mb-1">è¨­å®šç”Ÿè© (æ ¼å¼: ç”Ÿè©,æ‹¼éŸ³)</label>
                    <textarea id="vocab-input" rows="6" class="w-full p-2 border border-gray-300 rounded font-mono text-sm" placeholder="è˜‹æœ,pÃ­ng guÇ’..."></textarea>
                    <div class="text-xs text-gray-400 text-right">å»ºè­°è¼¸å…¥ 28 å€‹ç”Ÿè©</div>
                </div>
            </div>

            <button onclick="startGame()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-3 rounded-xl text-xl shadow-lg transition transform hover:-translate-y-1">
                ğŸš€ é–‹å§‹éŠæˆ² (Start Game)
            </button>
        </div>
    </div>

    <div id="game-container" class="hidden w-full h-full p-2 flex flex-col items-center justify-center relative">
        
        <div class="w-full max-w-4xl flex justify-between items-center mb-2 px-2">
            <div class="flex items-center gap-2 bg-white/80 p-2 rounded-lg shadow border-l-4 border-red-500" id="p1-info-box">
                <div class="text-2xl" id="p1-avatar-display">ğŸ‘©â€ğŸ«</div>
                <div>
                    <div class="text-xs opacity-70" id="p1-name-display">è€å¸«</div>
                    <div class="font-bold text-red-700">$<span id="p1-money">1000</span></div>
                </div>
            </div>
            
            <div class="text-center md:px-4">
                <div id="turn-indicator" class="text-sm px-4 py-1 bg-gray-800 text-white rounded-full shadow-sm whitespace-nowrap">
                    ç­‰å¾…é–‹å§‹...
                </div>
            </div>

            <div class="flex items-center gap-2 bg-white/80 p-2 rounded-lg shadow border-l-4 border-blue-500" id="p2-info-box">
                <div class="text-2xl" id="p2-avatar-display">ğŸ‘¨â€ğŸ“</div>
                <div>
                    <div class="text-xs opacity-70" id="p2-name-display">å­¸ç”Ÿ</div>
                    <div class="font-bold text-blue-700">$<span id="p2-money">1000</span></div>
                </div>
            </div>
        </div>

        <div class="board-grid" id="board">
            <div class="center-area shadow-inner">
                <div class="text-6xl mb-2 transition-transform" id="dice-display">ğŸ²</div>
                <button id="roll-btn" onclick="rollDice()" class="px-6 py-2 bg-gray-900 text-white rounded-full text-lg font-bold shadow hover:bg-gray-700 transition">
                    æ“²éª°å­ (Roll)
                </button>
                <div id="message-box" class="mt-3 text-center text-sm min-h-[20px] font-medium bg-white/50 px-2 rounded">
                    æº–å‚™é–‹å§‹!
                </div>
            </div>
        </div>

    </div>

    <div id="quiz-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-gray-500 text-sm mb-2">é€™å€‹å­—çš„æ‹¼éŸ³æ˜¯ï¼Ÿ</h3>
            <h2 id="quiz-word" class="text-5xl font-bold mb-6 text-center">ç”Ÿè©</h2>
            <div id="quiz-options" class="space-y-3"></div>
        </div>
    </div>

    <div id="buy-modal" class="modal">
        <div class="modal-content">
            <div class="text-4xl mb-2">ğŸ‰ ç­”å°äº†ï¼</div>
            <p class="mb-4 text-gray-600">ç²å¾—çé‡‘ <span class="text-green-600 font-bold">+$100</span></p>
            <div class="bg-yellow-50 p-3 rounded-lg mb-4 border border-yellow-200 inline-block">
                <span class="text-sm text-gray-500">åœŸåœ°åƒ¹æ ¼:</span>
                <span id="land-price" class="text-2xl font-bold text-yellow-700 ml-2">$200</span>
            </div>
            <p class="text-sm mb-4 font-bold" id="buy-prompt-text">è¦è²·ä¸‹é€™å¡Šåœ°å—ï¼Ÿ</p>
            <div class="flex gap-3 justify-center">
                <button id="buy-confirm-btn" onclick="handleBuy(true)" class="bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded-lg font-bold shadow">è²· (Buy)</button>
                <button onclick="handleBuy(false)" class="bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-6 rounded-lg font-bold">ä¸è²· (Pass)</button>
            </div>
        </div>
    </div>

    <div id="game-over-modal" class="modal">
        <div class="modal-content relative overflow-hidden">
            <h1 class="text-4xl mb-2">ğŸ† éŠæˆ²çµæŸ</h1>
            <div class="text-6xl mb-4" id="winner-avatar">ğŸ‘©â€ğŸ«</div>
            <p id="winner-text" class="text-2xl font-bold mb-2 text-blue-600">è€å¸«ç²å‹ï¼</p>
            <p id="win-reason" class="text-gray-500 mb-6">(å°æ‰‹ç ´ç”¢)</p>
            <button onclick="location.reload()" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-10 rounded-full font-bold shadow-lg hover:scale-105 transition">å†ä¾†ä¸€å±€</button>
        </div>
    </div>

    <script>
        // --- éŸ³æ•ˆç®¡ç† ---
        // ä½¿ç”¨è¼ƒç©©å®šçš„ CDN éŸ³æ•ˆä¾†æº
        const sounds = {
            dice: new Audio('https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3'), // éª°å­è²
            buy: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'), // æ”¶éŠ€æ©Ÿè²
            pay: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3'), // æå¤±è²
            win: new Audio('https://assets.mixkit.co/active_storage/sfx/2020/2020-preview.mp3')  // å‹åˆ©è²
        };
        // é è¼‰ä¸¦è¨­å®šéŸ³é‡
        Object.values(sounds).forEach(s => { s.volume = 0.5; s.load(); });

        function playSound(name) {
            // é˜²æ­¢ç€è¦½å™¨é˜»æ“‹è‡ªå‹•æ’­æ”¾ï¼Œéœ€åœ¨ä½¿ç”¨è€…äº’å‹•å¾Œè§¸ç™¼
            sounds[name].currentTime = 0;
            sounds[name].play().catch(e => console.log("Audio play failed:", e));
        }

        // --- é è¨­è³‡æ–™ ---
        const defaultVocab = `é–‹å§‹,kÄi shÇ\næº–å‚™,zhÇ”n bÃ¨i\nå› ç‚º,yÄ«n wÃ¨i\næ‰€ä»¥,suÇ’ yÇ\né›–ç„¶,suÄ« rÃ¡n\nä½†æ˜¯,dÃ n shÃ¬\nå¦‚æœ,rÃº guÇ’\nè¦ºå¾—,juÃ© de\nå–œæ­¡,xÇ huÄn\nèªè­˜,rÃ¨n shi\nä»‹ç´¹,jiÃ¨ shÃ o\nå¹«å¿™,bÄng mÃ¡ng\nå¿«æ¨‚,kuÃ i lÃ¨\nå®¹æ˜“,rÃ³ng yÃ¬\nç°¡å–®,jiÇn dÄn\nè¾›è‹¦,xÄ«n kÇ”\nå¥åº·,jiÃ n kÄng\né‹å‹•,yÃ¹n dÃ²ng\næ—…è¡Œ,lÇš xÃ­ng\nåƒè§€,cÄn guÄn\né¢¨æ™¯,fÄ“ng jÇng\næ—…é¤¨,lÇš guÇn\næ©Ÿç¥¨,jÄ« piÃ o\nè­·ç…§,hÃ¹ zhÃ o\næ–¹ä¾¿,fÄng biÃ n\néº»ç…©,mÃ¡ fan\nç·´ç¿’,liÃ n xÃ­\nè¤‡ç¿’,fÃ¹ xÃ­`;
        document.getElementById('vocab-input').value = defaultVocab;

        // --- éŠæˆ²ç‹€æ…‹ ---
        let vocabList = [];
        let tiles = []; // 28 tiles
        let players = []; // å°‡åœ¨ startGame åˆå§‹åŒ–
        let currentPlayerIndex = 0;
        let isRolling = false;
        
        // --- åˆå§‹åŒ–éŠæˆ² ---
        function startGame() {
            // 1. è¨­å®šä¸»é¡Œ
            const theme = document.getElementById('theme-select').value;
            document.body.className = `${theme} h-screen flex flex-col items-center overflow-hidden bg-gray-100`;

            // 2. åˆå§‹åŒ–ç©å®¶è³‡æ–™
            players = [
                { 
                    id: 0, 
                    name: document.getElementById('p1-name').value || "ç©å®¶1",
                    avatar: document.getElementById('p1-avatar').value,
                    money: 1000, pos: 0, color: "#ef4444", borderColor: "border-red-500" 
                },
                { 
                    id: 1, 
                    name: document.getElementById('p2-name').value || "ç©å®¶2",
                    avatar: document.getElementById('p2-avatar').value,
                    money: 1000, pos: 0, color: "#3b82f6", borderColor: "border-blue-500" 
                }
            ];
            
            // æ›´æ–°ä»‹é¢ä¸Šçš„ç©å®¶è³‡è¨Š
            document.getElementById('p1-name-display').innerText = players[0].name;
            document.getElementById('p1-avatar-display').innerText = players[0].avatar;
            document.getElementById('p2-name-display').innerText = players[1].name;
            document.getElementById('p2-avatar-display').innerText = players[1].avatar;

            // 3. è™•ç†ç”Ÿè©
            const input = document.getElementById('vocab-input').value;
            vocabList = input.trim().split('\n').map(line => {
                const [word, pinyin] = line.split(',');
                return { word: word?.trim(), pinyin: pinyin?.trim() };
            }).filter(v => v.word && v.pinyin);

            while(vocabList.length < 28) vocabList.push({word: "ç„¡é¡Œ", pinyin: "wÃº tÃ­"});
            if(vocabList.length > 28) vocabList = vocabList.slice(0, 28);

            // 4. ç”Ÿæˆåœ°åœ–è³‡æ–™
            tiles = vocabList.map((v, i) => ({
                id: i, word: v.word, pinyin: v.pinyin,
                price: Math.floor(Math.random() * 10) * 25 + 25, // 25 ~ 250
                owner: null
            }));

            // 5. æ¸²æŸ“ç•«é¢
            renderBoard();
            updateStats();
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            updateTurnIndicator();
        }

        // --- æ¸²æŸ“æ£‹ç›¤é‚è¼¯ (8x8 å£å­—å‹ = 28æ ¼) ---
        function renderBoard() {
            const board = document.getElementById('board');
            const center = document.querySelector('.center-area');
            board.innerHTML = ''; board.appendChild(center);

            const positions = [];
            for(let i=1; i<=8; i++) positions.push({r:1, c:i}); // Top
            for(let i=2; i<=7; i++) positions.push({r:i, c:8}); // Right
            for(let i=8; i>=1; i--) positions.push({r:8, c:i}); // Bottom
            for(let i=7; i>=2; i--) positions.push({r:i, c:1}); // Left

            tiles.forEach((tile, index) => {
                const pos = positions[index];
                const el = document.createElement('div');
                el.className = 'cell bg-white/90';
                el.style.gridRow = pos.r; el.style.gridColumn = pos.c; el.id = `cell-${index}`;
                el.innerHTML = `
                    <div class="text-[10px] text-gray-400">LAND</div>
                    <div class="font-bold text-gray-700">$${tile.price}</div>
                    <div class="owner-mark" id="owner-${index}"></div>
                `;
                board.appendChild(el);
            });
            updatePlayerTokens();
        }

        function updatePlayerTokens() {
            document.querySelectorAll('.token').forEach(e => e.remove());
            players.forEach((p, i) => {
                const cell = document.getElementById(`cell-${p.pos}`);
                const token = document.createElement('div');
                token.className = `token p${i+1}`;
                token.innerText = p.avatar; // é¡¯ç¤ºé ­åƒ
                cell.appendChild(token);
            });
        }

        function updateStats() {
            document.getElementById('p1-money').innerText = players[0].money;
            document.getElementById('p2-money').innerText = players[1].money;
            if(players.some(p => p.money < 0) || players.some(p => p.money >= 2500)) endGame(); // æé«˜ä¸€é»ç²å‹é–€æª»åˆ° 2500
        }

        function updateTurnIndicator() {
            const p = players[currentPlayerIndex];
            const div = document.getElementById('turn-indicator');
            div.innerHTML = `è¼ªåˆ°: <span class="font-bold">${p.avatar} ${p.name}</span>`;
            // div.style.backgroundColor = p.color;
            div.className = `text-sm px-4 py-2 text-white rounded-full shadow-sm whitespace-nowrap transition-all border-2 ${p.borderColor.replace('border', 'bg')}`;
            
            document.getElementById('roll-btn').disabled = false;
            document.getElementById('roll-btn').classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
            document.getElementById('message-box').innerText = `${p.name} è«‹æ“²éª°å­...`;
        }

        // --- æ ¸å¿ƒéŠæˆ²æµç¨‹ ---
        function rollDice() {
            if(isRolling) return;
            isRolling = true;
            playSound('dice'); // æ’­æ”¾éŸ³æ•ˆ
            const btn = document.getElementById('roll-btn');
            const display = document.getElementById('dice-display');
            
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
            display.classList.add('animate-spin');

            let steps = 0;
            const interval = setInterval(() => {
                display.innerText = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][Math.floor(Math.random()*6)];
                steps++;
                if(steps > 8) {
                    clearInterval(interval);
                    display.classList.remove('animate-spin');
                    const stepsToMove = Math.floor(Math.random() * 6) + 1; 
                    display.innerText = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][stepsToMove-1];
                    movePlayer(stepsToMove);
                }
            }, 80);
        }

        function movePlayer(steps) {
            const p = players[currentPlayerIndex];
            let currentSteps = 0;
            const moveInterval = setInterval(() => {
                p.pos = (p.pos + 1) % 28;
                updatePlayerTokens();
                currentSteps++;
                if(currentSteps >= steps) {
                    clearInterval(moveInterval);
                    isRolling = false;
                    handleLandEvent(p.pos);
                }
            }, 250);
        }

        function handleLandEvent(pos) {
            const tile = tiles[pos];
            const p = players[currentPlayerIndex];
            const msg = document.getElementById('message-box');

            if (tile.owner === null) {
                msg.innerText = "èµ°åˆ°ç„¡ä¸»åœ°ï¼Œæº–å‚™å›ç­”å•é¡Œï¼";
                setTimeout(() => showQuiz(tile), 800);
            } else if (tile.owner === p.id) {
                msg.innerText = "å›åˆ°è‡ªå·±çš„é ˜åœ°ï¼Œä¼‘æ¯ä¸€ä¸‹ã€‚";
                setTimeout(nextTurn, 1000);
            } else {
                const owner = players[tile.owner];
                msg.innerHTML = `è¸©åˆ° ${owner.avatar} çš„åœ°ï¼æ”¯ä»˜éè·¯è²» <span class="text-red-600 font-bold">$50</span>`;
                playSound('pay'); // æ’­æ”¾éŸ³æ•ˆ
                p.money -= 50;
                owner.money += 50;
                updateStats();
                // è¦–è¦ºæç¤º
                document.getElementById(`cell-${pos}`).style.backgroundColor = '#fee2e2'; 
                setTimeout(() => {
                    document.getElementById(`cell-${pos}`).style.backgroundColor = '';
                    nextTurn();
                }, 1500);
            }
        }

        // --- å•ç­”èˆ‡è³¼è²· ---
        let currentQuizTile = null;
        function showQuiz(tile) {
            currentQuizTile = tile;
            const modal = document.getElementById('quiz-modal');
            document.getElementById('quiz-word').innerText = tile.word;
            const optsEl = document.getElementById('quiz-options');
            optsEl.innerHTML = '';

            const correctAnswer = tile.pinyin;
            let distractors = vocabList.filter(v => v.pinyin !== correctAnswer).map(v => v.pinyin)
                .sort(() => 0.5 - Math.random()).slice(0, 2);
            const options = [correctAnswer, ...distractors].sort(() => 0.5 - Math.random());

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full py-3 px-4 bg-gray-50 hover:bg-blue-100 border border-gray-200 rounded-lg text-lg font-medium transition text-left text-gray-700";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(opt === correctAnswer);
                optsEl.appendChild(btn);
            });
            modal.classList.add('active');
        }

        function handleAnswer(isCorrect) {
            document.getElementById('quiz-modal').classList.remove('active');
            if(isCorrect) {
                players[currentPlayerIndex].money += 100;
                updateStats();
                showBuyModal();
            } else {
                document.getElementById('message-box').innerText = "ç­”éŒ¯äº†ï¼ç„¡æ³•ç²å¾—çå‹µã€‚";
                setTimeout(nextTurn, 1000);
            }
        }

        function showBuyModal() {
            const p = players[currentPlayerIndex];
            const tile = currentQuizTile;
            const modal = document.getElementById('buy-modal');
            
            document.getElementById('land-price').innerText = `$${tile.price}`;
            document.getElementById('buy-prompt-text').innerText = `${p.avatar} ${p.name}ï¼Œè¦è²·ä¸‹é€™å¡Šåœ°å—ï¼Ÿ`;
            modal.classList.add('active');
            
            const buyBtn = document.getElementById('buy-confirm-btn');
            if(p.money < tile.price) {
                 buyBtn.disabled = true;
                 buyBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                 buyBtn.innerText = "éŒ¢ä¸å¤ ";
            } else {
                 buyBtn.disabled = false;
                 buyBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                 buyBtn.classList.add('bg-green-500');
                 buyBtn.innerText = "è²· (Buy)";
            }
        }

        function handleBuy(shouldBuy) {
            document.getElementById('buy-modal').classList.remove('active');
            const p = players[currentPlayerIndex];
            const tile = currentQuizTile;

            if(shouldBuy && p.money >= tile.price) {
                playSound('buy'); // æ’­æ”¾éŸ³æ•ˆ
                p.money -= tile.price;
                tile.owner = p.id;
                const mark = document.getElementById(`owner-${tile.id}`);
                mark.style.borderColor = p.color;
                mark.style.backgroundColor = p.color + '33';
                updateStats();
                document.getElementById('message-box').innerText = "è³¼è²·æˆåŠŸï¼";
            } else {
                document.getElementById('message-box').innerText = "æ”¾æ£„è³¼è²·ã€‚";
            }
            setTimeout(nextTurn, 1000);
        }

        function nextTurn() {
            currentPlayerIndex = (currentPlayerIndex + 1) % 2;
            updateTurnIndicator();
        }

        // --- éŠæˆ²çµæŸèˆ‡ç‰¹æ•ˆ ---
        function endGame() {
            playSound('win'); // æ’­æ”¾éŸ³æ•ˆ
            // æ–½æ”¾ç…™ç«ç‰¹æ•ˆ
            const duration = 3000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 200 };
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);

            const p1 = players[0], p2 = players[1];
            let winner = null, reason = "";
            if(p1.money < 0) { winner = p2; reason = `(${p1.name} ç ´ç”¢)`; }
            else if(p2.money < 0) { winner = p1; reason = `(${p2.name} ç ´ç”¢)`; }
            else if(p1.money >= 2500) { winner = p1; reason = "(è³‡ç”¢é”æ¨™)"; }
            else if(p2.money >= 2500) { winner = p2; reason = "(è³‡ç”¢é”æ¨™)"; }
            
            document.getElementById('winner-avatar').innerText = winner.avatar;
            document.getElementById('winner-text').innerText = `${winner.name} ç²å‹ï¼`;
            document.getElementById('win-reason').innerText = reason;
            document.getElementById('game-over-modal').classList.add('active');
        }
    </script>
</body>
</html>
