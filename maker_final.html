<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯èªè½åŠ›ç·´ç¿’ V5.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root { --bg: #fff; --text: #333; --card: #fff; --primary: #555; --border: #ccc; --radius: 10px; --shadow: 0 4px 6px rgba(0,0,0,0.1); }
        body { margin: 0; padding: 20px; font-family: 'Microsoft JhengHei', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; transition: background 0.5s ease; }
        .container { background: var(--card); padding: 30px; width: 95%; max-width: 800px; border-radius: var(--radius); box-shadow: var(--shadow); border: 2px solid var(--border); margin-bottom: 20px; position: relative; transition: all 0.3s ease; }
        .btn { background: var(--primary); color: #fff; border: none; padding: 10px 20px; border-radius: var(--radius); cursor: pointer; font-size: 16px; margin: 5px; transition: 0.2s; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        input, textarea, select { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid var(--border); border-radius: var(--radius); box-sizing: border-box; background: rgba(255,255,255,0.8); }
        
        /* è©å¡æ¨£å¼ */
        .word-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; min-height: 100px; padding: 20px; border: 2px dashed var(--border); border-radius: var(--radius); background: rgba(255,255,255,0.3); margin: 20px 0; }
        .word-card { background: var(--card); border: 2px solid var(--primary); padding: 10px 15px; border-radius: var(--radius); cursor: grab; font-size: 18px; font-weight: bold; user-select: none; touch-action: none; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); }
        .sortable-ghost { opacity: 0.3; background: #ddd; } .sortable-drag { transform: scale(1.1); cursor: grabbing; }

        /* --- 10å¤§é¢¨æ ¼æ¨£å¼ --- */
        body.style-morandi { --bg: #E0E5DF; --card: #F2F0EB; --primary: #8CA3A3; --text: #5E616D; --border: #AAB7B8; --radius: 12px; }
        
        body.style-watercolor { 
            --bg: #e3f2fd; --card: rgba(255,255,255,0.95); --primary: #4fc3f7; --text: #0277bd; --border: #81d4fa; --radius: 20px;
            background-image: radial-gradient(circle at 10% 10%, #b3e5fc 0%, transparent 40%), radial-gradient(circle at 90% 90%, #b2ebf2 0%, transparent 40%);
        }
        body.style-watercolor .word-card { border: 1px solid #b3e5fc; box-shadow: 0 4px 10px rgba(3,169,244,0.1); }

        body.style-flat { --bg: #FFC107; --card: #FFF; --primary: #2196F3; --text: #333; --border: #fff; --radius: 0; --shadow: 8px 8px 0 rgba(0,0,0,0.2); }
        body.style-flat .container { border: 4px solid #000; box-shadow: 8px 8px 0 #000; }
        body.style-flat .btn { border: 2px solid #000; box-shadow: 4px 4px 0 #000; color: #fff; }

        body.style-geometric { --bg: #263238; --card: #ECEFF1; --primary: #FF5722; --text: #37474F; --border: #37474F; --radius: 0; background-image: repeating-linear-gradient(45deg, #263238 25%, transparent 25%, transparent 75%, #263238 75%, #263238), repeating-linear-gradient(45deg, #263238 25%, #37474F 25%, #37474F 75%, #263238 75%, #263238); background-position: 0 0, 10px 10px; background-size: 20px 20px; }

        body.style-scene { --bg: #D7CCC8; --card: #FFF8E1; --primary: #795548; --text: #4E342E; --border: #8D6E63; --radius: 8px; }
        
        body.style-cute { --bg: #F8BBD0; --card: #FFF; --primary: #EC407A; --text: #880E4F; --border: #F48FB1; --radius: 25px; }
        
        body.style-print { --bg: #F5F5DC; --card: #FFF; --primary: #000; --text: #000; --border: #000; --radius: 0; }
        body.style-print .container { border-width: 3px; box-shadow: 5px 5px 0 #333; }
        
        body.style-icon { --bg: #F5F5F5; --card: #FFF; --primary: #6200EA; --text: #000; --border: #6200EA; --radius: 10px; }
        body.style-icon .word-card { border-width: 2px; }

        body.style-hybrid { --bg: #CFD8DC; --card: #FFF; --primary: #455A64; --text: #263238; --border: #90A4AE; --radius: 5px; --shadow: 0 10px 30px rgba(0,0,0,0.2); }

        body.style-chalk { --bg: #2b3a2e; --card: #344838; --primary: #ffcc80; --text: #fff; --border: #fff; --radius: 4px; }
        body.style-chalk .container { border: 6px solid #5d4037; box-shadow: inset 0 0 20px #000; }
        body.style-chalk .word-card { background: transparent; border: 2px dashed rgba(255,255,255,0.6); color: #fff; }
        body.style-chalk input, body.style-chalk textarea { background: rgba(255,255,255,0.1); color: #fff; }
        body.style-chalk .btn { background: #d84315; color: #fff; border: 1px solid #fff; }

        /* éš±è—å…ƒç´  */
        .hidden { display: none !important; }
        .stamp { position: absolute; right: 20px; bottom: 20px; font-size: 40px; border: 3px solid red; color: red; padding: 10px; transform: rotate(-15deg); border-radius: 50%; opacity: 0.7; }
    </style>
</head>
<body class="style-morandi"> <h1 id="page-title">ğŸ§ è¯èªè½åŠ›ç·´ç¿’ V5</h1>

    <div id="teacher-setup" class="container">
        <h2 style="border-bottom: 2px solid var(--border); padding-bottom: 10px;">ğŸ¨ è€å¸«å‡ºé¡Œå€</h2>
        
        <label>1. é¸æ“‡é¢¨æ ¼ (è«‹é»é¸é è¦½)</label>
        <select id="input-style" onchange="previewStyle()">
            <option value="style-morandi">1. è«è˜­è¿ªç²‰å½©</option>
            <option value="style-watercolor">2. æ°´å½©æšˆæŸ“</option>
            <option value="style-flat">3. æ‰å¹³æ’ç•«</option>
            <option value="style-geometric">4. å¹¾ä½•ç°¡åŒ–</option>
            <option value="style-scene">5. æ’ç•«å ´æ™¯</option>
            <option value="style-cute">6. Qç‰ˆäººç‰©</option>
            <option value="style-print">7. ç‰ˆç•«é¢¨æ ¼</option>
            <option value="style-icon">8. åœ–æ¨™é¢¨æ ¼</option>
            <option value="style-hybrid">9. å¯«çœŸæ··åˆ</option>
            <option value="style-chalk">10. æ•™æé»‘æ¿</option>
        </select>

        <label>2. ä½œæ¥­æ¨™é¡Œ</label>
        <input type="text" id="input-title" placeholder="ä¾‹å¦‚ï¼šç¬¬äº”èª² è½åŠ›æ¸¬é©—">
        
        <label>3. é é¦–åœ–ç‰‡ (é¸å¡«)</label>
        <input type="text" id="input-img" placeholder="https://...">

        <label>4. è¼¸å…¥é¡Œç›® (ç”¨ / åˆ‡å‰²)</label>
        <textarea id="input-sentences" placeholder="ç¯„ä¾‹ï¼š&#10;ä»Šå¤©/å¤©æ°£/çœŸ/ä¸éŒ¯/ã€‚&#10;æˆ‘/æƒ³/å–/å’–å•¡/ã€‚"></textarea>

        <button class="btn" onclick="generateLink()">âœ¨ ç”¢ç”Ÿä½œæ¥­é€£çµ</button>

        <div id="result-box" class="hidden" style="margin-top:20px; padding:15px; border:1px solid var(--border); background: rgba(255,255,255,0.5);">
            <p>âœ… ç¶²å€å·²ç”Ÿæˆ (è«‹è¤‡è£½é€™å€‹ç¶²å€å‚³çµ¦å­¸ç”Ÿ)ï¼š</p>
            <textarea id="generated-link" style="height:60px; font-size:12px;" readonly></textarea>
            <button class="btn" onclick="copyLink()">ğŸ“‹ è¤‡è£½</button>
            <button class="btn" onclick="testPlay()">ğŸ® è©¦ç© (è«‹æŒ‰æ­¤æ¸¬è©¦)</button>
        </div>
    </div>

    <div id="student-login" class="container hidden" style="text-align:center;">
        <img id="login-img" class="hidden" src="" style="max-height:150px; margin-bottom:15px; border-radius:var(--radius);">
        <h2 id="login-title">æº–å‚™é–‹å§‹</h2>
        <input type="text" id="student-name" placeholder="è«‹è¼¸å…¥åå­—" style="text-align:center; font-size:18px;">
        <br>
        <button class="btn" onclick="startQuiz()">ğŸš€ é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="game-area" class="container hidden">
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span id="display-name"></span>
            <span>ç¬¬ <span id="current-q">1</span> / <span id="total-q">1</span> é¡Œ</span>
        </div>
        <hr style="border-top: 1px solid var(--border); margin: 15px 0;">
        <img id="game-header-img" class="hidden" src="" style="max-height:120px; display:block; margin:0 auto;">
        <div style="text-align:center; margin: 20px 0;">
            <button class="btn" onclick="playAudio(1)">ğŸ”Š æ’­æ”¾</button>
            <button class="btn" style="opacity:0.8; font-size:14px;" onclick="playAudio(0.7)">ğŸ¢ æ…¢é€Ÿ</button>
        </div>
        <div class="word-container" id="sortable-list"></div>
        <div id="feedback" style="text-align:center; font-weight:bold; height:30px; margin:10px;"></div>
        <div style="text-align:center;">
            <button class="btn" onclick="checkAnswer()">âœ… æª¢æŸ¥</button>
            <button id="next-btn" class="btn hidden" onclick="nextQuestion()">ğŸ‘‰ ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="result-area" class="container hidden" style="text-align:center;">
        <h2>ğŸ† å­¸ç¿’æˆæœ</h2>
        <h3 id="result-title-display"></h3>
        <p>å§“åï¼š<strong id="result-name" style="font-size:24px;"></strong></p>
        <div style="font-size:60px; font-weight:bold; color:var(--primary); margin:20px;">
            <span id="final-score">100</span> <span style="font-size:20px;">åˆ†</span>
        </div>
        <p>æ—¥æœŸï¼š<span id="finish-date"></span></p>
        <div class="stamp">é€šé</div>
        <p style="color:var(--primary); font-size:14px;">(è«‹æˆªåœ–å›å‚³)</p>
    </div>

    <script>
        // åˆå§‹åŒ–è¨­å®šï¼Œé è¨­è«è˜­è¿ª
        let questions = [], currentIdx = 0, score = 0, studentName = "";
        let settings = { title: "è½åŠ›ç·´ç¿’", style: "style-morandi", img: "" };
        let sortableInstance = null;

        // 1. è€å¸«åˆ‡æ›é¢¨æ ¼é è¦½
        function previewStyle() {
            const selectedStyle = document.getElementById('input-style').value;
            document.body.className = selectedStyle; 
        }

        // 2. ç”¢ç”Ÿé€£çµ (é—œéµï¼šæ‰“åŒ… style)
        function generateLink() {
            const raw = document.getElementById('input-sentences').value.trim();
            if(!raw) return alert("è«‹è¼¸å…¥é¡Œç›®");
            
            const qList = raw.split('\n').filter(l=>l.trim()).map(l => {
                const chunks = l.split('/').map(w=>w.trim()).filter(w=>w);
                return chunks.length ? { full: chunks.join(""), words: chunks } : null;
            }).filter(x=>x);

            const pack = {
                s: {
                    title: document.getElementById('input-title').value.trim() || "è½åŠ›ç·´ç¿’",
                    style: document.getElementById('input-style').value, // æŠ“å–ç•¶å‰é¸æ“‡çš„é¢¨æ ¼
                    img: document.getElementById('input-img').value.trim()
                },
                q: qList
            };
            
            // å£“ç¸®
            if (typeof LZString === 'undefined') return alert("ç³»çµ±è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦");
            const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(pack));
            const url = `${window.location.href.split('?')[0]}?data=${compressed}`;
            
            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('generated-link').value = url;
        }

        function copyLink() {
            document.getElementById('generated-link').select();
            document.execCommand('copy');
            alert("å·²è¤‡è£½");
        }
        function testPlay() { window.location.href = document.getElementById('generated-link').value; }

        // 3. å­¸ç”Ÿç«¯è¼‰å…¥ (é—œéµï¼šè§£åŒ… style ä¸¦æ‡‰ç”¨)
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('data');
            
            if(data) {
                // å­¸ç”Ÿæ¨¡å¼
                try {
                    const decoded = JSON.parse(LZString.decompressFromEncodedURIComponent(data));
                    questions = decoded.q;
                    // å¦‚æœç¶²å€æœ‰è¨­å®šï¼Œå°±è¦†è“‹é è¨­å€¼
                    if(decoded.s) settings = decoded.s;
                    
                    enterStudentMode();
                } catch(e) { console.error(e); }
            } else {
                // è€å¸«æ¨¡å¼
                document.getElementById('teacher-setup').classList.remove('hidden');
                // é è¨­å…ˆå¥—ç”¨é¸å–®çš„ç¬¬ä¸€å€‹é¢¨æ ¼
                previewStyle();
            }
        }

        function enterStudentMode() {
            document.getElementById('teacher-setup').classList.add('hidden');
            document.getElementById('student-login').classList.remove('hidden');
            
            // ã€å¼·åˆ¶ç”Ÿæ•ˆã€‘å°‡ body çš„ class è¨­å®šç‚ºè€å¸«é¸çš„é¢¨æ ¼
            document.body.className = settings.style;
            
            document.getElementById('page-title').innerText = settings.title;
            document.getElementById('login-title').innerText = settings.title;
            if(settings.img) {
                document.getElementById('login-img').src = settings.img;
                document.getElementById('login-img').classList.remove('hidden');
                document.getElementById('game-header-img').src = settings.img;
            }
        }

        function startQuiz() {
            const n = document.getElementById('student-name').value.trim();
            if(!n) return alert("è«‹è¼¸å…¥åå­—");
            studentName = n;
            document.getElementById('student-login').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('display-name').innerText = n;
            if(settings.img) document.getElementById('game-header-img').classList.remove('hidden');
            
            currentIdx = 0; score = 0; loadQuestion();
        }

        function loadQuestion() {
            document.getElementById('current-q').innerText = currentIdx+1;
            document.getElementById('total-q').innerText = questions.length;
            const list = document.getElementById('sortable-list');
            list.innerHTML = "";
            document.getElementById('feedback').innerText = "";
            document.getElementById('next-btn').classList.add('hidden');

            let words = [...questions[currentIdx].words].sort(()=>Math.random()-0.5);
            words.forEach(w => {
                const div = document.createElement('div');
                div.className = 'word-card';
                div.innerText = w;
                list.appendChild(div);
            });

            if(sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(list, { animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag' });
        }

        function playAudio(rate) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(questions[currentIdx].full);
            u.lang = 'zh-TW'; u.rate = rate;
            window.speechSynthesis.speak(u);
        }

        let tried = false;
        function checkAnswer() {
            if(!document.getElementById('next-btn').classList.contains('hidden')) return;
            const ans = [...document.querySelectorAll('.word-card')].map(x=>x.innerText).join("");
            const fb = document.getElementById('feedback');
            
            if(ans === questions[currentIdx].full) {
                fb.innerText = "ğŸ‰ ç­”å°äº†ï¼"; fb.style.color = "green";
                if(!tried) score++;
                document.getElementById('next-btn').classList.remove('hidden');
                sortableInstance.option("disabled", true);
            } else {
                fb.innerText = "âŒ å†è©¦è©¦çœ‹"; fb.style.color = "red";
                tried = true;
            }
        }

        function nextQuestion() {
            currentIdx++; tried = false;
            if(currentIdx < questions.length) loadQuestion();
            else {
                document.getElementById('game-area').classList.add('hidden');
                document.getElementById('result-area').classList.remove('hidden');
                document.getElementById('result-title-display').innerText = settings.title;
                document.getElementById('result-name').innerText = studentName;
                document.getElementById('final-score').innerText = Math.round((score/questions.length)*100);
                const d = new Date();
                document.getElementById('finish-date').innerText = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
            }
        }
    </script>
</body>
</html>
