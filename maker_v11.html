<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯èªå¥å­é‡çµ„ V11.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root { --bg: #fff; --text: #333; --card: #fff; --primary: #555; --border: #ccc; --radius: 10px; --font: 'Microsoft JhengHei', sans-serif; }
        body { margin: 0; padding: 20px; font-family: var(--font); background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; transition: 0.3s; background-attachment: fixed; padding-bottom: 60px; }
        
        .container { 
            background: var(--card); padding: 30px; width: 95%; max-width: 800px; 
            border-radius: var(--radius); border: 2px solid var(--border); 
            margin-bottom: 20px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .btn { background: var(--primary); color: #fff; border: none; padding: 10px 25px; border-radius: var(--radius); cursor: pointer; font-size: 16px; margin: 5px; font-family: inherit; transition: 0.2s; box-shadow: 0 3px 0 rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(3px); box-shadow: none; } .btn:hover { filter: brightness(1.1); }
        .btn-tiny { background: #E91E63; }
        .btn-preview-gen { background: #FF9800; width: 100%; margin-bottom: 15px; font-weight: bold; }
        
        .preview-list { background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto; border: 1px dashed var(--border); margin-bottom: 15px; display: none; }
        .preview-item { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        .preview-item button { padding: 2px 8px; font-size: 12px; background: #607D8B; margin-left: 10px; }

        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid var(--border); border-radius: var(--radius); box-sizing: border-box; font-family: inherit; font-size: 16px;}

        .instruction-box { background: #E3F2FD; border-left: 5px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 4px; font-size: 14px; color: #333; line-height: 1.6; }
        .code-tag { background: #fff; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #D32F2F; font-weight: bold; border: 1px solid #ccc; }
        
        /* åœ–ç‰‡é¸æ“‡å€ */
        .img-select-container { display: flex; gap: 10px; margin-bottom: 10px; }
        .preview-header-img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; display: none; background: #eee; border: 1px solid #ddd; }

        .word-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; min-height: 100px; padding: 25px; border: 2px dashed var(--border); border-radius: var(--radius); background: rgba(255,255,255,0.4); margin: 20px 0; }
        .word-card { background: #fff; border: 2px solid var(--primary); padding: 12px 20px; border-radius: var(--radius); cursor: grab; font-size: 20px; font-weight: bold; user-select: none; touch-action: none; box-shadow: 3px 3px 0 rgba(0,0,0,0.15); transition: transform 0.1s; }
        .word-card:active { transform: scale(0.95); }
        .sortable-ghost { opacity: 0.4; background: #eee; } .sortable-drag { transform: rotate(3deg) scale(1.1); cursor: grabbing; }

        .footer-credit { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.9); text-align: center; padding: 10px 0; font-size: 14px; color: #666; border-top: 1px solid #ddd; backdrop-filter: blur(5px); z-index: 999; }
        .footer-credit span { font-weight: bold; color: #333; }

        /* é¢¨æ ¼æ¨£å¼ (ç²¾ç°¡ç‰ˆ) */
        body.style-morandi { --bg: #D8E2DC; --card: #F9F7F2; --primary: #9D8189; --text: #6D6875; --border: #B5B2BE; --radius: 12px; --font: 'Noto Serif TC', serif; } body.style-morandi .container { border: none; box-shadow: 0 10px 30px rgba(157, 129, 137, 0.2); }
        body.style-watercolor { --bg: #E3F2FD; --card: rgba(255,255,255,0.9); --primary: #0288D1; --text: #01579B; --border: #81D4FA; --radius: 25px; --font: 'Zen Maru Gothic', sans-serif; background-image: radial-gradient(circle at 10% 10%, #B3E5FC 0%, transparent 40%), radial-gradient(circle at 90% 80%, #E1F5FE 0%, transparent 40%); } body.style-watercolor .word-card { border-color: #B3E5FC; box-shadow: 0 5px 15px rgba(3,169,244,0.2); color: #0277BD; }
        body.style-flat { --bg: #FFD54F; --card: #FFF; --primary: #000; --text: #000; --border: #000; --radius: 0px; --font: 'Microsoft JhengHei', sans-serif; } body.style-flat .container { border: 4px solid #000; box-shadow: 8px 8px 0 #000; } body.style-flat .btn { border: 3px solid #000; background: #29B6F6; color: #000; font-weight: 900; box-shadow: 4px 4px 0 #000; } body.style-flat .word-card { border: 3px solid #000; box-shadow: 5px 5px 0 #000; background: #FF8A65; color: #fff; }
        body.style-geometric { --bg: #212121; --card: #333; --primary: #00E676; --text: #EEE; --border: #444; --radius: 5px; --font: sans-serif; background-image: linear-gradient(30deg, #2a2a2a 12%, transparent 12.5%, transparent 87%, #2a2a2a 87.5%, #2a2a2a), linear-gradient(150deg, #2a2a2a 12%, transparent 12.5%, transparent 87%, #2a2a2a 87.5%, #2a2a2a); background-size: 40px 70px; } body.style-geometric .container { border: 1px solid #555; box-shadow: 0 0 20px rgba(0,230,118,0.1); } body.style-geometric .word-card { background: #424242; color: #fff; border: 1px solid #00E676; }
        body.style-scene { --bg: #D7CCC8; --card: #FFF3E0; --primary: #5D4037; --text: #3E2723; --border: #8D6E63; --radius: 8px; --font: 'Noto Serif TC', serif; background: repeating-linear-gradient(45deg, #bcaaa4, #bcaaa4 10px, #a1887f 10px, #a1887f 20px); } body.style-scene .container { border: 6px solid #5D4037; background: #FFF8E1; } body.style-scene .word-card { background: #EFEBE9; border-bottom: 4px solid #8D6E63; }
        body.style-cute { --bg: #81D4FA; --card: #fff; --primary: #FF80AB; --text: #880E4F; --border: #fff; --radius: 30px; --font: 'Zen Maru Gothic', sans-serif; background-image: radial-gradient(circle 20px at 10% 20%, white 99%, transparent 100%), radial-gradient(circle 30px at 15% 15%, white 99%, transparent 100%), radial-gradient(circle 15px at 80% 80%, white 99%, transparent 100%); background-size: 200px 200px; } body.style-cute .container { border: 5px solid #FFF; box-shadow: 0 10px 0 rgba(255,255,255,0.3); }
        body.style-print { --bg: #EFE6DD; --card: #FDFBF7; --primary: #2C2C2C; --text: #2C2C2C; --border: #2C2C2C; --radius: 4px; --font: serif; } body.style-print .container { border-width: 3px; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjRkRGQkY3Ii8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNDQ0MiLz4KPC9zdmc+'); } body.style-print .word-card { box-shadow: 4px 4px 0 #2C2C2C; border-width: 2px; }
        body.style-icon { --bg: #f0f0f0; --card: #fff; --primary: #6200EA; --text: #000; --border: #E0E0E0; --radius: 8px; --font: monospace; background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px); background-size: 20px 20px; } body.style-icon .word-card { border: 2px solid #6200EA; color: #6200EA; background: #EDE7F6; }
        body.style-hybrid { --bg: #eee; --card: #fff; --primary: #1565C0; --text: #333; --border: #90CAF9; --radius: 2px; --font: cursive; background-color: #f4f3f2; } body.style-hybrid .container { background-image: linear-gradient(#e1e1e1 1px, transparent 1px); background-size: 100% 1.5em; border-left: 5px double #ef5350; padding-left: 40px; } body.style-hybrid .word-card { font-family: 'Microsoft JhengHei', sans-serif; transform: rotate(-1deg); box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        body.style-chalk { --bg: #2B3A2E; --card: #344838; --primary: #D84315; --text: #EEE; --border: #EEE; --radius: 5px; --font: sans-serif; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxmaWx0ZXIgaWQ9Im4iPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSI1IiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0idHJhbnNwYXJlbnQiLz4KPC9zdmc+'); } body.style-chalk .container { border: 8px solid #5D4037; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); } body.style-chalk .word-card { background: transparent; border: 2px dashed rgba(255,255,255,0.6); color: #fff; } body.style-chalk input, body.style-chalk textarea { background: rgba(255,255,255,0.1); color: white; border-color: #777; }
        
        .hidden { display: none !important; }
        .stamp { position: absolute; right: 20px; bottom: 20px; font-size: 40px; border: 3px solid #D32F2F; color: #D32F2F; padding: 15px; transform: rotate(-15deg); border-radius: 50%; opacity: 0.8; font-weight: bold; background: rgba(255,255,255,0.8); }
    </style>
</head>
<body class="style-morandi">

    <div class="footer-credit">Designed by <span>å°å¸«å¤§å³ç©ç´”è€å¸«</span> | Powered by AI Tool</div>

    <h1 id="page-title">ğŸ§ è¯èªè½åŠ› V11 (è¼•é‡ç‰ˆ)</h1>

    <div id="teacher-setup" class="container">
        <h2>ğŸ¨ è€å¸«å‡ºé¡Œå€</h2>
        
        <div class="instruction-box">
            <b>ğŸ’¡ è¼•é‡åŒ–èªªæ˜ï¼š</b> ç‚ºäº†è®“ç¶²å€èƒ½é †åˆ©ç¸®çŸ­ï¼Œè«‹å„ªå…ˆä½¿ç”¨ã€Œå…§å»ºåœ–åº«ã€æˆ–ã€Œåœ–ç‰‡ç¶²å€ã€ã€‚<br>
            <b>ğŸ’¡ ç ´éŸ³å­—ä¿®æ­£ï¼š</b> è«‹ç”¨ <span class="code-tag">{é¡¯ç¤ºå­—|åŒéŸ³å­—}</span> æ ¼å¼ã€‚<br>
            <b>ğŸ§ è©¦è½æª¢æŸ¥ï¼š</b> è¼¸å…¥å®Œå¾Œè«‹æŒ‰ã€Œç”¢ç”Ÿè©¦è½æŒ‰éˆ•ã€æª¢æŸ¥ç™¼éŸ³ã€‚
        </div>

        <label>1. é¸æ“‡ä¸»é¡Œé¢¨æ ¼</label>
        <select id="input-style" onchange="previewStyle()">
            <option value="style-morandi">1. è«è˜­è¿ª Morandi</option>
            <option value="style-watercolor">2. æ°´å½©æšˆæŸ“ Watercolor</option>
            <option value="style-flat">3. æ‰å¹³æ’ç•« Pop Art</option>
            <option value="style-geometric">4. å¹¾ä½•ç§‘æŠ€ Cyber</option>
            <option value="style-scene">5. å’–å•¡æœ¨ç´‹ Wood</option>
            <option value="style-cute">6. å¤©ç©ºé›²æœµ Sky</option>
            <option value="style-print">7. å¾©å¤é›œé» Retro</option>
            <option value="style-icon">8. æ–¹æ ¼ç­†è¨˜ Grid</option>
            <option value="style-hybrid">9. æ©«ç·šç­†è¨˜ Notebook</option>
            <option value="style-chalk">10. æ•™å®¤é»‘æ¿ Chalkboard</option>
        </select>

        <label>2. ä½œæ¥­æ¨™é¡Œ</label>
        <input type="text" id="input-title" placeholder="ä¾‹å¦‚ï¼šç¬¬å…­èª² å¥å­é‡çµ„">
        
        <label>3. é é¦–åœ–ç‰‡ (è«‹é¸æ“‡)</label>
        <div class="img-select-container">
            <select id="input-preset-img" onchange="handlePresetImg()">
                <option value="">(ç„¡åœ–ç‰‡)</option>
                <option value="https://images.unsplash.com/photo-1497633762265-9d179a990aa6?auto=format&fit=crop&w=600&q=80">1. æ›¸ç± (Books)</option>
                <option value="https://images.unsplash.com/photo-1503676260728-1c00da094a0b?auto=format&fit=crop&w=600&q=80">2. æ•™å®¤ (Classroom)</option>
                <option value="https://images.unsplash.com/photo-1472214103451-9374bd1c798e?auto=format&fit=crop&w=600&q=80">3. é¢¨æ™¯ (Nature)</option>
                <option value="https://images.unsplash.com/photo-1496449903678-68ddcb189a24?auto=format&fit=crop&w=600&q=80">4. åŸå¸‚ (City)</option>
                <option value="https://images.unsplash.com/photo-1516979187457-637abb4f9353?auto=format&fit=crop&w=600&q=80">5. å’–å•¡ (Cafe)</option>
                <option value="custom">è‡ªè¡Œè¼¸å…¥ç¶²å€...</option>
            </select>
            <input type="text" id="input-custom-img" placeholder="è«‹è²¼ä¸Šåœ–ç‰‡é€£çµ..." style="display:none; flex:1;" oninput="previewCustomImg()">
        </div>
        <img id="header-preview" class="preview-header-img">

        <label>4. è¼¸å…¥é¡Œç›® (ä¸€è¡Œä¸€é¡Œï¼Œç”¨ / åˆ‡å‰²)</label>
        <textarea id="input-sentences" placeholder="ç¯„ä¾‹ï¼š&#10;æˆ‘/è¦º{å¾—|çš„}/å¾ˆ/é–‹{å¿ƒ|æ–°}/ã€‚&#10;ä»Šå¤©/å¤©æ°£/çœŸ/ä¸éŒ¯/ã€‚" oninput="hidePreview()"></textarea>

        <button class="btn btn-preview-gen" onclick="renderPreviews()">ğŸ”Š ç”¢ç”Ÿè©¦è½æŒ‰éˆ• (æª¢æŸ¥ç™¼éŸ³)</button>
        <div id="preview-area" class="preview-list"></div>

        <button class="btn" onclick="generateLink()">âœ¨ ç”¢ç”Ÿä½œæ¥­é€£çµ</button>

        <div id="result-box" class="hidden" style="margin-top:20px; padding:15px; border:1px solid var(--border); background: rgba(255,255,255,0.5);">
            <p>âœ… ç¶²å€å·²ç”Ÿæˆ (è¼•é‡åŒ–)ï¼š</p>
            <textarea id="generated-link" style="height:60px; font-size:12px;" readonly></textarea>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" onclick="copyLink()">ğŸ“‹ è¤‡è£½ç¶²å€</button>
                <button class="btn btn-tiny" onclick="tryAutoShorten()">ğŸª„ è‡ªå‹•ç¸®çŸ­ (TinyURL)</button>
                <button class="btn" onclick="testPlay()">ğŸ® è©¦ç©</button>
            </div>
        </div>
    </div>

    <div id="student-login" class="container hidden" style="text-align:center;">
        <img id="login-img" class="preview-header-img" style="display:none; margin:0 auto 15px auto;">
        <h2 id="login-title">æº–å‚™é–‹å§‹</h2>
        <input type="text" id="student-name" placeholder="è«‹è¼¸å…¥åå­—" style="text-align:center; font-size:18px;">
        <br><br>
        <button class="btn" onclick="startQuiz()">ğŸš€ é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="game-area" class="container hidden">
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span id="display-name"></span>
            <span>ç¬¬ <span id="current-q">1</span> / <span id="total-q">1</span> é¡Œ</span>
        </div>
        <hr style="border-top: 1px solid var(--border); margin: 15px 0;">
        <img id="game-header-img" class="preview-header-img" style="display:none; margin:0 auto; height:100px;">
        
        <div style="text-align:center; margin: 20px 0;">
            <button class="btn" onclick="playAudio(1)">ğŸ”Š æ’­æ”¾</button>
            <button class="btn" style="opacity:0.8; font-size:14px;" onclick="playAudio(0.7)">ğŸ¢ æ…¢é€Ÿ</button>
        </div>

        <div class="word-container" id="sortable-list"></div>
        <div id="feedback" style="text-align:center; font-weight:bold; height:30px; margin:10px;"></div>

        <div style="text-align:center;">
            <button class="btn" onclick="checkAnswer()">âœ… æª¢æŸ¥</button>
            <button id="next-btn" class="btn hidden" onclick="nextQuestion()">ğŸ‘‰ ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="result-area" class="container hidden" style="text-align:center;">
        <div style="font-size:80px; margin-bottom:10px;">ğŸ†</div>
        <h2>æ­å–œå®Œæˆï¼</h2>
        <h3 id="result-title-display"></h3>
        <p>å§“åï¼š<strong id="result-name" style="font-size:24px;"></strong></p>
        <div style="font-size:60px; font-weight:bold; color:var(--primary); margin:20px;">
            <span id="final-score">100</span> <span style="font-size:20px;">åˆ†</span>
        </div>
        <p>æ—¥æœŸï¼š<span id="finish-date"></span></p>
        <div class="stamp">Excellent!</div>
        <p style="color:var(--primary); font-size:14px;">(è«‹æˆªåœ–å›å‚³)</p>
    </div>

    <script>
        let questions = [], currentIdx = 0, score = 0, studentName = "";
        let settings = { title: "è½åŠ›ç·´ç¿’", style: "style-morandi", img: "" };
        let sortableInstance = null;
        const correctSound = new Audio('https://raw.githubusercontent.com/Arza-3d/ar3.js/master/assets/audio/success.mp3');
        const victorySound = new Audio('https://raw.githubusercontent.com/Arza-3d/ar3.js/master/assets/audio/victory.mp3');

        // --- æ ¸å¿ƒï¼šç³¾éŸ³è§£æå™¨ ---
        function getSpeechText(text) { return text.replace(/\{(.+?)\|(.+?)\}/g, '$2'); }
        function getDisplayText(text) { return text.replace(/\{(.+?)\|(.+?)\}/g, '$1'); }

        // --- åœ–ç‰‡è™•ç† (V11æ–°é‚è¼¯) ---
        function handlePresetImg() {
            const select = document.getElementById('input-preset-img');
            const customInput = document.getElementById('input-custom-img');
            const preview = document.getElementById('header-preview');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                preview.style.display = 'none';
            } else {
                customInput.style.display = 'none';
                if (select.value) {
                    preview.src = select.value;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            }
        }

        function previewCustomImg() {
            const url = document.getElementById('input-custom-img').value;
            const preview = document.getElementById('header-preview');
            if(url) { preview.src = url; preview.style.display = 'block'; }
        }

        // --- æ‰¹æ¬¡è©¦è½ ---
        function hidePreview() { document.getElementById('preview-area').style.display = 'none'; }
        function renderPreviews() {
            const raw = document.getElementById('input-sentences').value.trim();
            if(!raw) return alert("è«‹å…ˆè¼¸å…¥é¡Œç›®");
            const lines = raw.split('\n').filter(l => l.trim());
            const list = document.getElementById('preview-area');
            list.innerHTML = "";
            lines.forEach((line, idx) => {
                const cleanLine = line.replace(/\//g, ''); 
                const speechText = getSpeechText(cleanLine);
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `<span>${idx+1}. ${cleanLine.substring(0, 15)}...</span><button onclick="previewSpeak('${speechText.replace(/'/g, "\\'")}')">â–¶</button>`;
                list.appendChild(div);
            });
            list.style.display = 'block';
        }
        function previewSpeak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW'; u.rate = 1.0;
            window.speechSynthesis.speak(u);
        }

        function previewStyle() { document.body.className = document.getElementById('input-style').value; }

        function generateLink() {
            const raw = document.getElementById('input-sentences').value.trim();
            if(!raw) return alert("è«‹è¼¸å…¥é¡Œç›®");
            
            const qList = raw.split('\n').filter(l=>l.trim()).map(l => {
                const chunks = l.split('/').map(w=>w.trim()).filter(w=>w);
                const rawFull = l.replace(/\//g, '').trim();
                return chunks.length ? { full: rawFull, words: chunks } : null;
            }).filter(x=>x);

            // åœ–ç‰‡é‚è¼¯
            let finalImg = "";
            const select = document.getElementById('input-preset-img');
            if(select.value === 'custom') finalImg = document.getElementById('input-custom-img').value.trim();
            else finalImg = select.value;

            const pack = {
                s: {
                    title: document.getElementById('input-title').value.trim() || "è½åŠ›ç·´ç¿’",
                    style: document.getElementById('input-style').value,
                    img: finalImg
                },
                q: qList
            };
            
            const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(pack));
            const url = `${window.location.href.split('?')[0]}?data=${compressed}`;
            
            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('generated-link').value = url;
        }

        function tryAutoShorten() {
            const longUrl = document.getElementById('generated-link').value;
            if(!longUrl) return;
            const btn = document.querySelector('.btn-tiny');
            btn.innerText = "â³ è™•ç†ä¸­..."; btn.disabled = true;
            fetch('https://tinyurl.com/api-create.php?url=' + encodeURIComponent(longUrl))
            .then(res => res.ok ? res.text() : null)
            .then(shortUrl => {
                if(shortUrl) {
                    document.getElementById('generated-link').value = shortUrl;
                    btn.innerText = "âœ… æˆåŠŸ";
                } else throw new Error();
            })
            .catch(() => {
                btn.innerText = "âŒ å¤±æ•—";
                if(confirm("è‡ªå‹•ç¸®ç¶²å€å¤±æ•—ï¼Œæ˜¯å¦æ‰‹å‹•é–‹å•Ÿ TinyURLï¼Ÿ")) {
                    copyLink(); window.open("https://tinyurl.com/app", "_blank");
                }
            });
        }

        function copyLink() {
            document.getElementById('generated-link').select();
            document.execCommand('copy');
            alert("å·²è¤‡è£½");
        }
        function testPlay() { window.location.href = document.getElementById('generated-link').value; }

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('data');
            if(data) {
                try {
                    const decoded = JSON.parse(LZString.decompressFromEncodedURIComponent(data));
                    questions = decoded.q; if(decoded.s) settings = decoded.s;
                    enterStudentMode();
                } catch(e) { console.error(e); }
            } else {
                document.getElementById('teacher-setup').classList.remove('hidden');
                previewStyle();
            }
        }

        function enterStudentMode() {
            document.getElementById('teacher-setup').classList.add('hidden');
            document.getElementById('student-login').classList.remove('hidden');
            document.body.className = settings.style;
            document.getElementById('page-title').innerText = settings.title;
            document.getElementById('login-title').innerText = settings.title;
            if(settings.img) {
                document.getElementById('login-img').src = settings.img;
                document.getElementById('login-img').style.display = 'block';
                document.getElementById('game-header-img').src = settings.img;
                document.getElementById('game-header-img').style.display = 'block';
            }
        }

        function startQuiz() {
            const n = document.getElementById('student-name').value.trim();
            if(!n) return alert("è«‹è¼¸å…¥åå­—");
            studentName = n;
            document.getElementById('student-login').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('display-name').innerText = n;
            currentIdx = 0; score = 0; loadQuestion();
        }

        function loadQuestion() {
            if (currentIdx >= questions.length) { showResult(); return; }
            document.getElementById('current-q').innerText = currentIdx+1;
            document.getElementById('total-q').innerText = questions.length;
            const list = document.getElementById('sortable-list');
            list.innerHTML = "";
            document.getElementById('feedback').innerText = "";
            document.getElementById('next-btn').classList.add('hidden');

            let words = [...questions[currentIdx].words].sort(()=>Math.random()-0.5);
            words.forEach(w => {
                const div = document.createElement('div');
                div.className = 'word-card';
                div.innerText = getDisplayText(w);
                div.dataset.raw = w; 
                list.appendChild(div);
            });

            if(sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(list, { animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag' });
        }

        function playAudio(rate) {
            window.speechSynthesis.cancel();
            const textToRead = getSpeechText(questions[currentIdx].full);
            const u = new SpeechSynthesisUtterance(textToRead);
            u.lang = 'zh-TW'; u.rate = rate;
            window.speechSynthesis.speak(u);
        }

        let tried = false;
        function checkAnswer() {
            if(!document.getElementById('next-btn').classList.contains('hidden')) return;
            const ans = [...document.querySelectorAll('.word-card')].map(x=>x.dataset.raw).join("");
            const fb = document.getElementById('feedback');
            
            if(ans === questions[currentIdx].full) {
                fb.innerText = "ğŸ‰ ç­”å°äº†ï¼"; fb.style.color = "green";
                correctSound.currentTime = 0; correctSound.play();
                if(!tried) score++;
                document.getElementById('next-btn').classList.remove('hidden');
                sortableInstance.option("disabled", true);
            } else {
                fb.innerText = "âŒ å†è©¦è©¦çœ‹"; fb.style.color = "red";
                tried = true;
            }
        }

        function nextQuestion() {
            currentIdx++; tried = false;
            if(currentIdx < questions.length) loadQuestion();
            else {
                document.getElementById('game-area').classList.add('hidden');
                document.getElementById('result-area').classList.remove('hidden');
                document.getElementById('result-title-display').innerText = settings.title;
                document.getElementById('result-name').innerText = studentName;
                document.getElementById('final-score').innerText = Math.round((score/questions.length)*100);
                const d = new Date();
                document.getElementById('finish-date').innerText = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
                victorySound.play();
                launchConfetti();
            }
        }

        function launchConfetti() {
            var duration = 3000; var end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }
    </script>
</body>
</html>
