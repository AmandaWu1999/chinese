<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè©å¤§å¯Œç¿ - AI è¯èªæ•™å­¸ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å­—é«”è¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=ZCOOL+KuaiLe&display=swap');

        /* åŸºç¤å‹•ç•« */
        @keyframes pop { 0% { transform: scale(0.9); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        body { font-family: 'Noto Sans TC', sans-serif; transition: background 0.5s ease; }
        
        /* éŠæˆ²ç›¤ä½ˆå±€ï¼šå£å­—å‹ */
        .board-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 6px;
            width: 100%;
            max-width: 900px;
            aspect-ratio: 1/1;
            margin: 0 auto;
        }

        .cell {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            font-size: 0.8rem;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 2px;
            text-align: center;
        }

        /* ä¸­å¤®æ§åˆ¶å€ */
        .center-area {
            grid-column: 2 / 9;
            grid-row: 2 / 9;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            padding: 20px;
            z-index: 10;
        }

        /* ç©å®¶æ£‹å­ */
        .token {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
            z-index: 20;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.5s ease-in-out;
        }
        .token.p1 { background-color: #ef4444; top: 5px; left: 5px; } /* ç´…è‰²ï¼šè€å¸« */
        .token.p2 { background-color: #3b82f6; bottom: 5px; right: 5px; } /* è—è‰²ï¼šå­¸ç”Ÿ */

        /* åœŸåœ°æ­¸å±¬æ¨™è¨˜ */
        .owner-mark {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border: 4px solid transparent;
            border-radius: 8px;
            pointer-events: none;
        }

        /* --- é¢¨æ ¼ä¸»é¡Œè®Šæ•¸ --- */
        /* 1. è«è˜­è¿ª Morandi */
        .theme-morandi { background-color: #e8e6e1; color: #5e5e5e; }
        .theme-morandi .cell { background-color: #d6cfc7; border: 1px solid #bfb7b0; }
        .theme-morandi .center-area { background-color: rgba(245, 242, 235, 0.9); }
        .theme-morandi button { background-color: #9cafb7; color: white; border-radius: 20px; }

        /* 2. é»‘æ¿ Chalkboard */
        .theme-chalkboard { background-color: #2b3a42; color: #eee; font-family: 'ZCOOL KuaiLe', cursive; }
        .theme-chalkboard .cell { background-color: #3e505b; border: 1px dashed rgba(255,255,255,0.3); color: white; }
        .theme-chalkboard .center-area { background-color: #2b3a42; border: 2px solid #aaa; }
        .theme-chalkboard button { background-color: #ef4444; border: 2px solid white; }

        /* 3. æ‰å¹³ Flat */
        .theme-flat { background-color: #f3f4f6; color: #1f2937; }
        .theme-flat .cell { background-color: white; border: 2px solid #e5e7eb; font-weight: bold; }
        .theme-flat .center-area { background-color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .theme-flat button { background-color: #3b82f6; border-radius: 8px; font-weight: bold; }

        /* 4. æ°´å½© Watercolor */
        .theme-watercolor { 
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); 
            color: #4a4a4a; 
        }
        .theme-watercolor .cell { 
            background: rgba(255,255,255,0.6); 
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: inset 0 0 20px rgba(173, 216, 230, 0.2);
            border-radius: 12px 4px 12px 4px;
        }
        .theme-watercolor .center-area { background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); }
        .theme-watercolor button { background: linear-gradient(to right, #a1c4fd 0%, #c2e9fb 100%); color: #fff; border: none; }

        /* 5. Qç‰ˆ Chibi */
        .theme-chibi { background-color: #fff1f2; font-family: 'ZCOOL KuaiLe', cursive; }
        .theme-chibi .cell { background-color: #ffe4e6; border: 3px solid #fda4af; border-radius: 15px; }
        .theme-chibi .center-area { background-color: #fff; border: 4px solid #f43f5e; border-radius: 20px; }
        .theme-chibi button { background-color: #f43f5e; border-radius: 50px; box-shadow: 0 4px 0 #be123c; transform: translateY(-2px); }
        .theme-chibi button:active { transform: translateY(0); box-shadow: 0 0 0; }

        /* 6. å¹¾ä½• Geometric */
        .theme-geometric { background-color: #111827; color: #d1d5db; }
        .theme-geometric .cell { background-color: #1f2937; border: 1px solid #374151; border-radius: 0; }
        .theme-geometric .center-area { background-color: #111827; border: 1px solid #4b5563; }
        .theme-geometric button { background-color: #10b981; border-radius: 0; text-transform: uppercase; letter-spacing: 2px; }

        /* Modal Overlay */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px;
            text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

    </style>
</head>
<body class="theme-flat h-screen flex flex-col items-center overflow-hidden">

    <div id="setup-screen" class="w-full h-full absolute top-0 left-0 bg-white z-50 flex flex-col items-center justify-center p-4 overflow-y-auto">
        <div class="max-w-2xl w-full space-y-6">
            <h1 class="text-4xl font-bold text-gray-800 text-center mb-2">ğŸ“ è¯èªç”Ÿè©å¤§å¯Œç¿</h1>
            <p class="text-gray-500 text-center">è¼¸å…¥å–®å­—èˆ‡æ‹¼éŸ³ï¼Œè‡ªå‹•ç”ŸæˆéŠæˆ²</p>

            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                <label class="block text-sm font-medium text-gray-700 mb-2">1. é¸æ“‡éŠæˆ²é¢¨æ ¼</label>
                <select id="theme-select" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
                    <option value="theme-flat">æ‰å¹³æ’ç•«é¢¨ (Flat)</option>
                    <option value="theme-morandi">è«è˜­è¿ªç²‰å½© (Morandi)</option>
                    <option value="theme-watercolor">æ°´å½©æ¸²æŸ“é¢¨ (Watercolor)</option>
                    <option value="theme-chalkboard">æ•™å®¤é»‘æ¿é¢¨ (Chalkboard)</option>
                    <option value="theme-chibi">Q ç‰ˆå¯æ„›é¢¨ (Chibi)</option>
                    <option value="theme-geometric">æš—é»‘å¹¾ä½•é¢¨ (Geometric)</option>
                </select>

                <label class="block text-sm font-medium text-gray-700 mb-2">2. è¨­å®šç”Ÿè© (æ ¼å¼ï¼šç”Ÿè©,æ‹¼éŸ³ - ä¸€è¡Œä¸€å€‹)</label>
                <textarea id="vocab-input" rows="10" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-sm" placeholder="ä¾‹å¦‚ï¼š
è˜‹æœ,pÃ­ng guÇ’
å­¸æ ¡,xuÃ© xiÃ o"></textarea>
                <div class="text-xs text-gray-400 mt-1 text-right">å»ºè­°è‡³å°‘è¼¸å…¥ 28 å€‹ç”Ÿè©ä»¥å¡«æ»¿æ£‹ç›¤</div>
            </div>

            <button onclick="startGame()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl text-xl shadow-lg transition transform hover:-translate-y-1">
                é–‹å§‹éŠæˆ² (Start Game)
            </button>
        </div>
    </div>

    <div id="game-container" class="hidden w-full h-full p-2 flex flex-col items-center justify-center relative">
        
        <div class="w-full max-w-4xl flex justify-between items-center mb-2 px-4">
            <div class="player-card p1-card bg-red-100 border-l-4 border-red-500 p-3 rounded shadow flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center font-bold">å¸«</div>
                <div>
                    <div class="text-xs text-gray-500">Player 1 (è€å¸«)</div>
                    <div class="font-bold text-lg text-red-700">$<span id="p1-money">1000</span></div>
                </div>
            </div>
            
            <div class="text-center">
                <h2 class="text-xl font-bold opacity-70">Vocabulary Monopoly</h2>
                <div id="turn-indicator" class="text-sm px-3 py-1 bg-gray-800 text-white rounded-full mt-1">
                    ç­‰å¾…é–‹å§‹...
                </div>
            </div>

            <div class="player-card p2-card bg-blue-100 border-l-4 border-blue-500 p-3 rounded shadow flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold">ç”Ÿ</div>
                <div>
                    <div class="text-xs text-gray-500">Player 2 (å­¸ç”Ÿ)</div>
                    <div class="font-bold text-lg text-blue-700">$<span id="p2-money">1000</span></div>
                </div>
            </div>
        </div>

        <div class="board-grid" id="board">
            <div class="center-area">
                <div class="text-6xl mb-4 animate-bounce" id="dice-display">ğŸ²</div>
                <button id="roll-btn" onclick="rollDice()" class="px-8 py-3 text-lg font-bold shadow-lg transition">
                    æ“²éª°å­ (Roll)
                </button>
                <div id="message-box" class="mt-4 text-center text-sm min-h-[40px] opacity-80">
                    è«‹æŒ‰æŒ‰éˆ•é–‹å§‹å›åˆ
                </div>
            </div>
        </div>

    </div>

    <div id="quiz-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-gray-500 text-sm mb-1">è«‹å›ç­”é€™å€‹å­—çš„æ‹¼éŸ³</h3>
            <h2 id="quiz-word" class="text-5xl font-bold text-gray-800 mb-6">ç”Ÿè©</h2>
            <div id="quiz-options" class="space-y-3">
                </div>
        </div>
    </div>

    <div id="buy-modal" class="modal">
        <div class="modal-content">
            <div class="text-4xl mb-2">ğŸ‰ ç­”å°äº†ï¼</div>
            <p class="mb-4 text-gray-600">ä½ ç²å¾—äº†çé‡‘ <span class="text-green-600 font-bold">+$100</span></p>
            <div class="bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                <p class="text-sm text-gray-500">åœŸåœ°åƒ¹æ ¼</p>
                <p id="land-price" class="text-2xl font-bold text-yellow-700">$200</p>
            </div>
            <p class="text-sm text-gray-500 mb-4">è¦è²·ä¸‹é€™å¡Šåœ°å—ï¼Ÿ(å°æ‰‹è¸©åˆ°éœ€ä»˜ $50)</p>
            <div class="flex gap-4 justify-center">
                <button onclick="handleBuy(true)" class="bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded-lg font-bold">è²· (Buy)</button>
                <button onclick="handleBuy(false)" class="bg-gray-400 hover:bg-gray-500 text-white py-2 px-6 rounded-lg">ä¸è²· (Pass)</button>
            </div>
        </div>
    </div>

    <div id="game-over-modal" class="modal">
        <div class="modal-content">
            <h1 class="text-4xl mb-4">ğŸ† éŠæˆ²çµæŸ</h1>
            <p id="winner-text" class="text-xl font-bold mb-6">è€å¸«ç²å‹ï¼</p>
            <button onclick="location.reload()" class="bg-blue-600 text-white py-3 px-8 rounded-lg font-bold">å†ä¾†ä¸€å±€</button>
        </div>
    </div>

    <script>
        // --- é è¨­è³‡æ–™ ---
        const defaultVocab = `é–‹å§‹,kÄi shÇ\næº–å‚™,zhÇ”n bÃ¨i\nå› ç‚º,yÄ«n wÃ¨i\næ‰€ä»¥,suÇ’ yÇ\né›–ç„¶,suÄ« rÃ¡n\nä½†æ˜¯,dÃ n shÃ¬\nå¦‚æœ,rÃº guÇ’\nè¦ºå¾—,juÃ© de\nå–œæ­¡,xÇ huÄn\nèªè­˜,rÃ¨n shi\nä»‹ç´¹,jiÃ¨ shÃ o\nå¹«å¿™,bÄng mÃ¡ng\nå¿«æ¨‚,kuÃ i lÃ¨\nå®¹æ˜“,rÃ³ng yÃ¬\nç°¡å–®,jiÇn dÄn\nè¾›è‹¦,xÄ«n kÇ”\nå¥åº·,jiÃ n kÄng\né‹å‹•,yÃ¹n dÃ²ng\næ—…è¡Œ,lÇš xÃ­ng\nåƒè§€,cÄn guÄn\né¢¨æ™¯,fÄ“ng jÇng\næ—…é¤¨,lÇš guÇn\næ©Ÿç¥¨,jÄ« piÃ o\nè­·ç…§,hÃ¹ zhÃ o\næ–¹ä¾¿,fÄng biÃ n\néº»ç…©,mÃ¡ fan\nç·´ç¿’,liÃ n xÃ­\nè¤‡ç¿’,fÃ¹ xÃ­`;

        document.getElementById('vocab-input').value = defaultVocab;

        // --- éŠæˆ²ç‹€æ…‹ ---
        let vocabList = [];
        let tiles = []; // 28 tiles
        let players = [
            { id: 0, name: "è€å¸«", money: 1000, pos: 0, color: "#ef4444" },
            { id: 1, name: "å­¸ç”Ÿ", money: 1000, pos: 0, color: "#3b82f6" }
        ];
        let currentPlayerIndex = 0;
        let isRolling = false;
        
        // --- åˆå§‹åŒ–éŠæˆ² ---
        function startGame() {
            // 1. è¨­å®šä¸»é¡Œ
            const theme = document.getElementById('theme-select').value;
            document.body.className = `${theme} h-screen flex flex-col items-center overflow-hidden`;

            // 2. è™•ç†ç”Ÿè©
            const input = document.getElementById('vocab-input').value;
            vocabList = input.trim().split('\n').map(line => {
                const [word, pinyin] = line.split(',');
                return { word: word?.trim(), pinyin: pinyin?.trim() };
            }).filter(v => v.word && v.pinyin);

            // è£œæ»¿æˆ–è£åˆ‡è‡³ 28 å€‹
            while(vocabList.length < 28) vocabList.push({word: "ç©ºç™½", pinyin: "kÃ²ng bÃ¡i"});
            if(vocabList.length > 28) vocabList = vocabList.slice(0, 28);

            // 3. ç”Ÿæˆåœ°åœ–è³‡æ–™
            tiles = vocabList.map((v, i) => ({
                id: i,
                word: v.word,
                pinyin: v.pinyin,
                price: Math.floor(Math.random() * 10) * 25 + 25, // 25 ~ 250
                owner: null
            }));

            // 4. æ¸²æŸ“ç•«é¢
            renderBoard();
            updateStats();
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            updateTurnIndicator();
        }

        // --- æ¸²æŸ“æ£‹ç›¤é‚è¼¯ (å£å­—å‹) ---
        function renderBoard() {
            const board = document.getElementById('board');
            // æ¸…é™¤é™¤äº† center-area ä»¥å¤–çš„å…§å®¹
            const center = document.querySelector('.center-area');
            board.innerHTML = '';
            board.appendChild(center);

            // å®šç¾© 28 æ ¼çš„è·¯å¾‘ (9x9 grid)
            // Top: (1,1) -> (1,9) | Right: (2,9) -> (9,9) | Bottom: (9,8) -> (9,1) | Left: (8,1) -> (2,1)
            const path = [];
            // Top (0-8)
            for(let c=1; c<=9; c++) path.push({r:1, c:c});
            // Right (9-15) - æ‰£æ‰å³ä¸Šè§’
            for(let r=2; r<=8; r++) path.push({r:r, c:9});
            // Bottom (16-24) - åŒ…å«å³ä¸‹è§’
            for(let c=9; c>=1; c--) path.push({r:9, c:c});
            // Left (25-27) - æ‰£æ‰å·¦ä¸‹å’Œå·¦ä¸Š
            for(let r=8; r>=2; r--) path.push({r:r, c:1});

            // ä¿®æ­£ï¼šæˆ‘å€‘çš„ path é•·åº¦æ˜¯ 9+7+9+7 = 32æ ¼ (å¤ªå¤šäº†)
            // éœ€æ±‚æ˜¯ 28 æ ¼ã€‚
            // 8x8 Grid = 28 border cells? 8 top + 6 right + 8 bottom + 6 left = 28. Correct.
            // Grid size should be 9x9 lines? No, 8x8 cells.
            // Let's use Grid 9x9 styles for spacing but logic needs 28 steps.
            // Grid Template 9x9 -> 8 cells on edge.
            // Top Row (1, 1-8) -> 8 cells
            // Right Col (2-8, 8) -> 7 cells?
            // Let's manually map indices 0-27 to grid positions (Row, Col)
            const coords = [
                // Top Row (0-8) -> 9 cells? 28 total.
                // Side length 8. 8*4 - 4 = 28. Perfect.
                // Row 1, Col 1~8
                [1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[1,8],
                // Right Col, Row 1~8, Col 9? No let's stick to 9x9 grid to render 8 cells properly
                // Let's mapping simply:
                // 0-7: Top row (r1, c1~8)
                // 8-13: Right col (r2~7, c8)
                // 14-21: Bottom row (r8, c8~1)
                // 22-27: Left col (r7~2, c1)
            ];

            // Re-calc specific for 9x9 Grid CSS (1-based)
            const mapPos = [];
            for(let i=0; i<8; i++) mapPos.push({r:1, c:i+1}); // 0-7 Top
            for(let i=0; i<6; i++) mapPos.push({r:i+2, c:9}); // 8-13 Right (using col 9 to make it wider? No, grid is 9x9 defined in CSS. Let's use 8x8 logic but CSS is 9x9 to have center space)
            
            // ä¿®æ­£ CSS Grid ç‚º 9x9. 
            // é ‚éƒ¨ 0-7 æ”¾ (1,1)~(1,8) -> é€™æ¨£å³é‚Šé‚„æœ‰ä¸€æ ¼ (1,9) ç©ºè‘—?
            // è®“æˆ‘å€‘ç°¡å–®é»ï¼šé †æ™‚é‡æ’åˆ—
            // ç¸½å…± 28 æ ¼ã€‚æ¯é‚Šå¹³å‡ 7 æ ¼ï¼Ÿ 7*4=28.
            // Top: 0-7 (8æ ¼) -> col 1~8, row 1
            // Right: 8-13 (6æ ¼) -> col 9, row 2~7  (Wait, col 8 is end of top? Let's make grid 9x9)
            // Let's use absolute positioning logic based on Grid.
            
            // Final Mapping Logic for 28 tiles on 9x9 Grid (center 7x7 empty)
            // 0-8 (9 tiles top)
            // 9-13 (5 tiles right)
            // 14-22 (9 tiles bottom)
            // 23-27 (5 tiles left)
            // Total: 9+5+9+5 = 28. Perfect.
            
            const gridMap = [
                // Top: Row 1, Col 1-9
                {r:1,c:1},{r:1,c:2},{r:1,c:3},{r:1,c:4},{r:1,c:5},{r:1,c:6},{r:1,c:7},{r:1,c:8},{r:1,c:9},
                // Right: Col 9, Row 2-6 (5 tiles)
                {r:2,c:9},{r:3,c:9},{r:4,c:9},{r:5,c:9},{r:6,c:9},
                // Bottom: Row 7, Col 9-1 (9 tiles) -> Wait, let's allow grid to be 7 rows high?
                // Let's force grid 9 cols, 7 rows? No square.
                // Simple: 8 cols, 8 rows.
                // 0-7: r1, c1-8
                // 8-13: r2-7, c8
                // 14-21: r8, c8-1
                // 22-27: r7-2, c1
            ];
            
            // ä½¿ç”¨ 8x8 é‚è¼¯
            document.querySelector('.board-grid').style.gridTemplateColumns = 'repeat(8, 1fr)';
            document.querySelector('.board-grid').style.gridTemplateRows = 'repeat(8, 1fr)';
            
            // Center spans
            center.style.gridColumn = '2 / 8';
            center.style.gridRow = '2 / 8';

            const positions = [];
            // Top 0-7
            for(let i=1; i<=8; i++) positions.push({r:1, c:i});
            // Right 8-13
            for(let i=2; i<=7; i++) positions.push({r:i, c:8});
            // Bottom 14-21 (Reversed)
            for(let i=8; i>=1; i--) positions.push({r:8, c:i});
            // Left 22-27 (Reversed)
            for(let i=7; i>=2; i--) positions.push({r:i, c:1});

            // å»ºç«‹æ ¼å­ DOM
            tiles.forEach((tile, index) => {
                const pos = positions[index];
                const el = document.createElement('div');
                el.className = 'cell bg-white/80';
                el.style.gridRow = pos.r;
                el.style.gridColumn = pos.c;
                el.id = `cell-${index}`;
                
                // å…§å®¹ï¼šåªé¡¯ç¤ºåƒ¹æ ¼ï¼Œä¸é¡¯ç¤ºç”Ÿè©
                el.innerHTML = `
                    <div class="text-xs text-gray-400 mb-1">Land</div>
                    <div class="font-bold text-gray-700">$${tile.price}</div>
                    <div class="owner-mark" id="owner-${index}"></div>
                `;
                board.appendChild(el);
            });

            // åˆå§‹åŒ–æ£‹å­
            updatePlayerTokens();
        }

        function updatePlayerTokens() {
            // ç§»é™¤èˆŠæ£‹å­
            document.querySelectorAll('.token').forEach(e => e.remove());
            const board = document.getElementById('board');

            players.forEach((p, i) => {
                const cell = document.getElementById(`cell-${p.pos}`);
                const token = document.createElement('div');
                token.className = `token p${i+1}`;
                cell.appendChild(token);
            });
        }

        function updateStats() {
            document.getElementById('p1-money').innerText = players[0].money;
            document.getElementById('p2-money').innerText = players[1].money;
            
            // æª¢æŸ¥å‹è² 
            if(players.some(p => p.money <= 0) || players.some(p => p.money >= 2000)) {
                endGame();
            }
        }

        function updateTurnIndicator() {
            const p = players[currentPlayerIndex];
            const div = document.getElementById('turn-indicator');
            div.innerText = `è¼ªåˆ°ï¼š${p.name}`;
            div.style.backgroundColor = p.color;
            
            document.getElementById('roll-btn').disabled = false;
            document.getElementById('roll-btn').classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('message-box').innerText = `${p.name} è«‹æ“²éª°å­...`;
        }

        // --- æ ¸å¿ƒéŠæˆ²æµç¨‹ ---

        function rollDice() {
            if(isRolling) return;
            isRolling = true;
            const btn = document.getElementById('roll-btn');
            const display = document.getElementById('dice-display');
            
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            // å‹•ç•«
            let steps = 0;
            const interval = setInterval(() => {
                display.innerText = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][Math.floor(Math.random()*6)];
                steps++;
                if(steps > 10) {
                    clearInterval(interval);
                    const stepsToMove = Math.floor(Math.random() * 6) + 1; // 1-6
                    display.innerText = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][stepsToMove-1];
                    movePlayer(stepsToMove);
                }
            }, 100);
        }

        function movePlayer(steps) {
            const p = players[currentPlayerIndex];
            let currentSteps = 0;
            
            const moveInterval = setInterval(() => {
                p.pos = (p.pos + 1) % 28;
                updatePlayerTokens();
                currentSteps++;

                // ç¶“éåŸé»çå‹µ (é€™è£¡ç°¡åŒ–ä¸ç‰¹åˆ¥åŠ éŒ¢ï¼Œé¿å…éŒ¢å¤ªå¤š)
                
                if(currentSteps >= steps) {
                    clearInterval(moveInterval);
                    isRolling = false;
                    handleLandEvent(p.pos);
                }
            }, 200);
        }

        function handleLandEvent(pos) {
            const tile = tiles[pos];
            const p = players[currentPlayerIndex];
            const msg = document.getElementById('message-box');

            // 1. ç„¡ä¸»åœ° -> è§¸ç™¼å•ç­”
            if (tile.owner === null) {
                msg.innerText = "èµ°åˆ°ç„¡ä¸»åœ°ï¼Œæº–å‚™å›ç­”å•é¡Œï¼";
                setTimeout(() => showQuiz(tile), 1000);
            } 
            // 2. è‡ªå·±çš„åœ°
            else if (tile.owner === p.id) {
                msg.innerText = "å›åˆ°è‡ªå·±çš„é ˜åœ°ï¼Œä¼‘æ¯ä¸€ä¸‹ã€‚";
                nextTurn();
            }
            // 3. å°æ‰‹çš„åœ° -> ä»˜éè·¯è²»
            else {
                msg.innerText = `è¸©åˆ°å°æ‰‹çš„åœ°ï¼æ”¯ä»˜éè·¯è²» $50`;
                p.money -= 50;
                players[tile.owner].money += 50;
                updateStats();
                
                // å‹•ç•«æ•ˆæœ
                const cell = document.getElementById(`cell-${pos}`);
                cell.classList.add('bg-red-200');
                setTimeout(() => cell.classList.remove('bg-red-200'), 500);
                
                setTimeout(nextTurn, 1500);
            }
        }

        // --- å•ç­”ç³»çµ± ---
        let currentQuizTile = null;

        function showQuiz(tile) {
            currentQuizTile = tile;
            const modal = document.getElementById('quiz-modal');
            const wordEl = document.getElementById('quiz-word');
            const optsEl = document.getElementById('quiz-options');

            wordEl.innerText = tile.word;
            optsEl.innerHTML = '';

            // æº–å‚™é¸é … (1æ­£2èª¤)
            const correctAnswer = tile.pinyin;
            let distractors = vocabList
                .filter(v => v.pinyin !== correctAnswer)
                .map(v => v.pinyin)
                .sort(() => 0.5 - Math.random()) // Shuffle
                .slice(0, 2);
            
            const options = [correctAnswer, ...distractors].sort(() => 0.5 - Math.random());

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full py-3 px-4 bg-gray-100 hover:bg-blue-100 border border-gray-300 rounded-lg text-lg font-medium transition text-left";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(opt === correctAnswer);
                optsEl.appendChild(btn);
            });

            modal.classList.add('active');
        }

        function handleAnswer(isCorrect) {
            const quizModal = document.getElementById('quiz-modal');
            quizModal.classList.remove('active');

            if(isCorrect) {
                // ç­”å°ï¼šåŠ éŒ¢ + è©¢å•è³¼è²·
                players[currentPlayerIndex].money += 100;
                updateStats();
                showBuyModal();
            } else {
                // ç­”éŒ¯ï¼šçµæŸå›åˆ
                document.getElementById('message-box').innerText = "ç­”éŒ¯äº†ï¼ç„¡æ³•ç²å¾—çå‹µã€‚";
                nextTurn();
            }
        }

        function showBuyModal() {
            const p = players[currentPlayerIndex];
            const tile = currentQuizTile;
            const modal = document.getElementById('buy-modal');
            
            document.getElementById('land-price').innerText = `$${tile.price}`;
            modal.classList.add('active');
            
            // å¦‚æœéŒ¢ä¸å¤ ï¼Œåªèƒ½ pass (é›–ç„¶æŒ‰éˆ•é‚„åœ¨ï¼Œä½†é‚è¼¯æ“‹ä¸€ä¸‹æ›´å¥½ï¼Œé€™è£¡å…ˆç”¨è¦–è¦ºæç¤º)
             const buyBtn = modal.querySelectorAll('button')[0];
             if(p.money < tile.price) {
                 buyBtn.disabled = true;
                 buyBtn.classList.add('opacity-50', 'cursor-not-allowed');
                 buyBtn.innerText = "éŒ¢ä¸å¤ ";
             } else {
                 buyBtn.disabled = false;
                 buyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                 buyBtn.innerText = "è²· (Buy)";
             }
        }

        function handleBuy(shouldBuy) {
            const modal = document.getElementById('buy-modal');
            modal.classList.remove('active');
            
            const p = players[currentPlayerIndex];
            const tile = currentQuizTile;

            if(shouldBuy && p.money >= tile.price) {
                p.money -= tile.price;
                tile.owner = p.id;
                
                // æ›´æ–°æ ¼å­è¦–è¦º
                const mark = document.getElementById(`owner-${tile.id}`);
                mark.style.borderColor = p.color;
                mark.style.backgroundColor = p.color + '20'; // 20% opacity
                
                updateStats();
                document.getElementById('message-box').innerText = "è³¼è²·æˆåŠŸï¼";
            } else {
                document.getElementById('message-box').innerText = "æ”¾æ£„è³¼è²·ã€‚";
            }

            setTimeout(nextTurn, 1000);
        }

        function nextTurn() {
            currentPlayerIndex = (currentPlayerIndex + 1) % 2;
            updateTurnIndicator();
        }

        function endGame() {
            const p1 = players[0];
            const p2 = players[1];
            let winner = "";
            
            if(p1.money <= 0) winner = "å­¸ç”Ÿç²å‹ (è€å¸«ç ´ç”¢)";
            else if(p2.money <= 0) winner = "è€å¸«ç²å‹ (å­¸ç”Ÿç ´ç”¢)";
            else if(p1.money >= 2000) winner = "è€å¸«ç²å‹ (è³‡ç”¢é”æ¨™)";
            else if(p2.money >= 2000) winner = "å­¸ç”Ÿç²å‹ (è³‡ç”¢é”æ¨™)";
            else winner = p1.money > p2.money ? "è€å¸«ç²å‹" : "å­¸ç”Ÿç²å‹";

            document.getElementById('winner-text').innerText = winner;
            document.getElementById('game-over-modal').classList.add('active');
        }

    </script>
</body>
</html>
